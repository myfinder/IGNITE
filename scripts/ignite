#!/bin/bash
# IGNITE - 統合コマンド
# Intelligent Generative Networked Interaction-driven Task Engine

set -e
set -u

VERSION="0.1.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# =============================================================================
# XDG パス解決（インストールモード vs 開発モード）
# =============================================================================

# XDG Base Directory paths
XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"

# インストールモード判定: ~/.config/ignite/.install_paths が存在するか
INSTALLED_MODE=false
if [[ -f "$XDG_CONFIG_HOME/ignite/.install_paths" ]]; then
    INSTALLED_MODE=true
fi

# パス解決
if [[ "$INSTALLED_MODE" == "true" ]]; then
    # インストールモード: XDGパスを使用
    IGNITE_CONFIG_DIR="$XDG_CONFIG_HOME/ignite"
    IGNITE_DATA_DIR="$XDG_DATA_HOME/ignite"
    IGNITE_INSTRUCTIONS_DIR="$IGNITE_DATA_DIR/instructions"
    IGNITE_SCRIPTS_DIR="$IGNITE_DATA_DIR/scripts"
    DEFAULT_WORKSPACE_DIR="$HOME/ignite-workspace"
else
    # 開発モード: PROJECT_ROOTを使用
    IGNITE_CONFIG_DIR="$PROJECT_ROOT/config"
    IGNITE_DATA_DIR="$PROJECT_ROOT"
    IGNITE_INSTRUCTIONS_DIR="$PROJECT_ROOT/instructions"
    IGNITE_SCRIPTS_DIR="$PROJECT_ROOT/scripts"
    DEFAULT_WORKSPACE_DIR="$PROJECT_ROOT/workspace"
fi

# セッション名とワークスペース（後でコマンドラインで上書き可能）
SESSION_NAME=""
WORKSPACE_DIR=""

# Sub-Leaders 定義
SUB_LEADERS=("strategist" "architect" "evaluator" "coordinator" "innovator")
SUB_LEADER_NAMES=("義賀リオ" "祢音ナナ" "衣結ノア" "通瀬アイナ" "恵那ツムギ")

# デフォルト設定
DEFAULT_WORKER_COUNT=8

# Claude セッションデータのパス（PROJECT_ROOT から動的に生成）
# Claude Code は /path/to/project を -path-to-project に変換してディレクトリ名にする
CLAUDE_PROJECTS_DIR="$HOME/.claude/projects/$(echo "$PROJECT_ROOT" | sed 's|/|-|g')"

# カラー定義
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# =============================================================================
# セッションID・ワークスペース管理
# =============================================================================

# セッションIDの自動生成（4文字のハッシュ）
generate_session_id() {
    # プロジェクトパス + タイムスタンプから短いIDを生成
    echo "ignite-$(echo "${PROJECT_ROOT}-$(date +%s)" | md5sum | cut -c1-4)"
}

# デフォルトのワークスペースパス
get_default_workspace() {
    echo "$DEFAULT_WORKSPACE_DIR"
}

# セッションIDの設定（指定がなければ自動生成）
setup_session_name() {
    if [[ -z "$SESSION_NAME" ]]; then
        # 既存セッションを検索
        local existing_session
        existing_session=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | grep "^ignite-" | head -1 || true)

        if [[ -n "$existing_session" ]]; then
            SESSION_NAME="$existing_session"
        else
            SESSION_NAME=$(generate_session_id)
        fi
    fi
}

# ワークスペースの設定（指定がなければデフォルト）
setup_workspace() {
    if [[ -z "$WORKSPACE_DIR" ]]; then
        WORKSPACE_DIR=$(get_default_workspace)
    fi
}

# 実行中の全IGNITEセッションを一覧表示
list_sessions() {
    local sessions
    sessions=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | grep "^ignite-" || true)

    if [[ -z "$sessions" ]]; then
        print_warning "実行中のIGNITEセッションはありません"
        return 1
    fi

    echo "$sessions"
}

# 共通関数
print_info() { echo -e "${BLUE}$1${NC}"; }
print_success() { echo -e "${GREEN}✓ $1${NC}"; }
print_warning() { echo -e "${YELLOW}⚠ $1${NC}"; }
print_error() { echo -e "${RED}❌ $1${NC}"; }
print_header() { echo -e "${BOLD}${CYAN}=== $1 ===${NC}"; }

# セッションが存在するかチェック
session_exists() {
    tmux has-session -t "$SESSION_NAME" 2>/dev/null
}

# 設定ファイルからワーカー数を取得
get_worker_count() {
    local config_file="$IGNITE_CONFIG_DIR/ignitians.yaml"
    if [[ -f "$config_file" ]]; then
        local count
        count=$(grep "default:" "$config_file" | head -1 | awk '{print $2}')
        if [[ -n "$count" ]] && [[ "$count" =~ ^[0-9]+$ ]]; then
            echo "$count"
            return
        fi
    fi
    echo "$DEFAULT_WORKER_COUNT"
}

# GitHub Watcher自動起動設定を取得
get_watcher_auto_start() {
    local config_file="$IGNITE_CONFIG_DIR/github-watcher.yaml"
    if [[ -f "$config_file" ]]; then
        local enabled=$(grep -E '^\s*enabled:' "$config_file" | head -1 | awk '{print $2}')
        [[ "$enabled" == "true" ]]
    else
        return 1
    fi
}

# エージェント起動関数（最大3回リトライ）
start_agent() {
    local role="$1"      # strategist, architect, etc.
    local name="$2"      # 義賀リオ, 祢音ナナ, etc.
    local pane="$3"      # ペイン番号
    local max_retries=3
    local retry=0

    while [[ $retry -lt $max_retries ]]; do
        print_info "${name} を起動中... (試行 $((retry+1))/$max_retries)"

        # ペイン作成
        tmux split-window -t "$SESSION_NAME:ignite" -h
        tmux select-layout -t "$SESSION_NAME:ignite" tiled

        # Claude CLI 起動（ワークスペースディレクトリで実行）
        tmux send-keys -t "$SESSION_NAME:ignite.$pane" \
            "cd '$WORKSPACE_DIR' && claude --model claude-opus-4-5-20251101 --dangerously-skip-permissions" Enter
        sleep 3

        # 権限確認通過
        tmux send-keys -t "$SESSION_NAME:ignite.$pane" Down
        sleep 0.5
        tmux send-keys -t "$SESSION_NAME:ignite.$pane" Enter
        sleep 8

        # 起動確認（ペインが生きているか）
        if tmux list-panes -t "$SESSION_NAME:ignite" 2>/dev/null | grep -q "$pane:"; then
            # システムプロンプト読み込み（絶対パスを使用）
            tmux send-keys -t "$SESSION_NAME:ignite.$pane" \
                "$IGNITE_INSTRUCTIONS_DIR/${role}.md を読んで、あなたは${name}として振る舞ってください。ワークスペースは $WORKSPACE_DIR です。$WORKSPACE_DIR/queue/${role}/ のメッセージを監視してください。instructions内の workspace/ は $WORKSPACE_DIR に読み替えてください。"
            sleep 0.3
            tmux send-keys -t "$SESSION_NAME:ignite.$pane" C-m
            sleep 2  # プロンプト送信後の安定待機
            print_success "${name} 起動完了"
            return 0
        fi

        print_warning "${name} 起動失敗、リトライ中..."
        ((retry++))
        sleep 2
    done

    print_error "${name} 起動に失敗しました（${max_retries}回試行）"
    return 1
}

# IGNITIANS 起動関数
start_ignitian() {
    local id="$1"        # IGNITIAN番号 (1, 2, 3, ...)
    local pane="$2"      # ペイン番号
    local max_retries=3
    local retry=0

    while [[ $retry -lt $max_retries ]]; do
        print_info "IGNITIAN-${id} を起動中... (試行 $((retry+1))/$max_retries)"

        # ペイン作成
        tmux split-window -t "$SESSION_NAME:ignite" -h
        tmux select-layout -t "$SESSION_NAME:ignite" tiled

        # Claude CLI 起動（ワークスペースディレクトリで実行）
        tmux send-keys -t "$SESSION_NAME:ignite.$pane" \
            "cd '$WORKSPACE_DIR' && claude --model claude-opus-4-5-20251101 --dangerously-skip-permissions" Enter
        sleep 3

        # 権限確認通過
        tmux send-keys -t "$SESSION_NAME:ignite.$pane" Down
        sleep 0.5
        tmux send-keys -t "$SESSION_NAME:ignite.$pane" Enter
        sleep 8

        # 起動確認
        if tmux list-panes -t "$SESSION_NAME:ignite" 2>/dev/null | grep -q "$pane:"; then
            # システムプロンプト読み込み（絶対パスを使用）
            tmux send-keys -t "$SESSION_NAME:ignite.$pane" \
                "$IGNITE_INSTRUCTIONS_DIR/ignitian.md を読んで、あなたはIGNITIAN-${id}として振る舞ってください。ワークスペースは $WORKSPACE_DIR です。$WORKSPACE_DIR/queue/ignitians/ignitian_${id}.yaml を監視してください。instructions内の workspace/ は $WORKSPACE_DIR に読み替えてください。"
            sleep 0.3
            tmux send-keys -t "$SESSION_NAME:ignite.$pane" C-m
            sleep 2  # プロンプト送信後の安定待機
            print_success "IGNITIAN-${id} 起動完了"
            return 0
        fi

        print_warning "IGNITIAN-${id} 起動失敗、リトライ中..."
        ((retry++))
        sleep 2
    done

    print_error "IGNITIAN-${id} 起動に失敗しました（${max_retries}回試行）"
    return 1
}

# =============================================================================
# start コマンド
# =============================================================================
cmd_start() {
    local no_attach=false
    local force=false
    local agent_mode="full"    # full, leader, sub
    local worker_count=""
    local no_workers=false
    local with_watcher=""      # 空=設定に従う, true=起動, false=起動しない

    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -n|--no-attach) no_attach=true; shift ;;
            -f|--force) force=true; shift ;;
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -w|--workspace)
                WORKSPACE_DIR="$2"
                if [[ ! "$WORKSPACE_DIR" = /* ]]; then
                    WORKSPACE_DIR="$(pwd)/$WORKSPACE_DIR"
                fi
                shift 2
                ;;
            -a|--agents)
                agent_mode="$2"
                if [[ ! "$agent_mode" =~ ^(full|leader|sub)$ ]]; then
                    print_error "無効なエージェントモード: $agent_mode (full/leader/sub)"
                    exit 1
                fi
                shift 2
                ;;
            --workers)
                worker_count="$2"
                if [[ ! "$worker_count" =~ ^[0-9]+$ ]] || [[ "$worker_count" -lt 1 ]] || [[ "$worker_count" -gt 32 ]]; then
                    print_error "ワーカー数は1-32の範囲で指定してください: $worker_count"
                    exit 1
                fi
                shift 2
                ;;
            --no-workers) no_workers=true; shift ;;
            --with-watcher) with_watcher=true; shift ;;
            --no-watcher) with_watcher=false; shift ;;
            -h|--help) cmd_help start; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help start; exit 1 ;;
        esac
    done

    # セッション名が未指定の場合は自動生成
    if [[ -z "$SESSION_NAME" ]]; then
        SESSION_NAME=$(generate_session_id)
    fi

    # ワークスペースが未指定の場合はデフォルト
    setup_workspace

    # ワーカー数の決定
    if [[ -z "$worker_count" ]]; then
        worker_count=$(get_worker_count)
    fi

    # --no-workers が指定された場合
    if [[ "$no_workers" == true ]]; then
        worker_count=0
    fi

    # agent_mode が leader の場合は Sub-Leaders も起動しない
    if [[ "$agent_mode" == "leader" ]]; then
        worker_count=0
    fi

    # エラートラップ
    trap 'print_error "エラーが発生しました (line $LINENO)"' ERR

    print_header "IGNITE システム起動"
    echo ""
    echo -e "${BLUE}セッションID:${NC} $SESSION_NAME"
    echo -e "${BLUE}ワークスペース:${NC} $WORKSPACE_DIR"
    echo -e "${BLUE}起動モード:${NC} $agent_mode"
    if [[ "$agent_mode" != "leader" ]]; then
        echo -e "${BLUE}Sub-Leaders:${NC} ${#SUB_LEADERS[@]}名"
    fi
    if [[ "$worker_count" -gt 0 ]]; then
        echo -e "${BLUE}IGNITIANs:${NC} ${worker_count}並列"
    fi
    echo ""

    cd "$WORKSPACE_DIR"

    # 既存のセッションチェック
    if session_exists; then
        if [[ "$force" == true ]]; then
            print_warning "既存のセッションを強制終了します"
            tmux kill-session -t "$SESSION_NAME"
            print_success "既存セッションを終了しました"
        else
            print_warning "既存のignite-sessionが見つかりました"
            read -p "既存のセッションを終了して再起動しますか? (y/N): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                tmux kill-session -t "$SESSION_NAME"
                print_success "既存セッションを終了しました"
            else
                print_info "既存セッションにアタッチします"
                tmux attach -t "$SESSION_NAME"
                exit 0
            fi
        fi
    fi

    # workspaceの初期化
    print_info "workspaceを初期化中..."
    mkdir -p "$WORKSPACE_DIR/queue"/{leader,strategist,architect,evaluator,coordinator,innovator,ignitians}
    mkdir -p "$WORKSPACE_DIR/reports"
    mkdir -p "$WORKSPACE_DIR/context"
    mkdir -p "$WORKSPACE_DIR/logs"
    mkdir -p "$WORKSPACE_DIR/state"  # Watcher用ステートファイル保存先
    mkdir -p "$WORKSPACE_DIR/repos"  # 外部リポジトリのclone先

    # 初期ダッシュボードの作成
    print_info "初期ダッシュボードを作成中..."
    cat > "$WORKSPACE_DIR/dashboard.md" <<EOF
# IGNITE Dashboard

更新日時: $(date '+%Y-%m-%d %H:%M:%S')

## システム状態
⏳ Leader (伊羽ユイ): 起動中...

## 現在のタスク
タスクなし - システム起動中

## 最新ログ
[$(date '+%H:%M:%S')] システム起動を開始しました
EOF

    print_success "workspace初期化完了"
    echo ""

    # tmuxセッション作成
    print_info "tmuxセッションを作成中..."
    tmux new-session -d -s "$SESSION_NAME" -n ignite
    sleep 0.5  # セッション作成を待機

    # Leader ペイン (pane 0)
    print_info "Leader (伊羽ユイ) を起動中..."
    tmux send-keys -t "$SESSION_NAME:ignite" \
        "cd '$WORKSPACE_DIR' && claude --model claude-opus-4-5-20251101 --dangerously-skip-permissions" Enter

    # 起動待機（確認プロンプト表示を待つ）
    print_warning "Leaderの起動を待機中... (3秒)"
    sleep 3

    # 確認プロンプトを通過（下矢印で "Yes, I accept" を選択してEnter）
    print_info "権限確認を承諾中..."
    tmux send-keys -t "$SESSION_NAME:ignite" Down
    sleep 0.5
    tmux send-keys -t "$SESSION_NAME:ignite" Enter

    # Claude Codeの起動完了を待機
    print_warning "Claude Codeの起動を待機中... (8秒)"
    sleep 8

    # Leaderにシステムプロンプトを読み込ませる（絶対パスを使用）
    print_info "Leaderシステムプロンプトをロード中..."
    local instruction_file="$IGNITE_INSTRUCTIONS_DIR/leader.md"
    if [[ "$agent_mode" == "leader" ]]; then
        instruction_file="$IGNITE_INSTRUCTIONS_DIR/leader-solo.md"
        print_info "単独モード: $instruction_file を使用"
    fi
    tmux send-keys -t "$SESSION_NAME:ignite" \
        "$instruction_file を読んで、あなたはLeader（伊羽ユイ）として振る舞ってください。ワークスペースは $WORKSPACE_DIR です。$WORKSPACE_DIR/queue/leader/ 内のメッセージを確認してください。instructions内の workspace/ は $WORKSPACE_DIR に読み替えてください。"
    sleep 0.3
    tmux send-keys -t "$SESSION_NAME:ignite" C-m

    # プロンプトロード完了を待機
    print_warning "Leaderの初期化を待機中... (10秒)"
    sleep 10

    # 初期メッセージの送信
    print_info "Leaderに初期化メッセージを送信中..."
    cat > "$WORKSPACE_DIR/queue/leader/system_init_$(date +%s).yaml" <<EOF
type: system_init
from: system
to: leader
timestamp: "$(date -Iseconds)"
priority: high
payload:
  message: "システムが起動しました。初期化を完了してください。"
  action: "initialize_dashboard"
status: pending
EOF

    echo ""
    print_success "IGNITE Leader が起動しました"

    # Sub-Leaders の起動 (agent_mode が leader 以外の場合)
    if [[ "$agent_mode" != "leader" ]]; then
        echo ""
        print_header "Sub-Leaders 起動"
        echo ""

        local pane_num=1
        for i in "${!SUB_LEADERS[@]}"; do
            local role="${SUB_LEADERS[$i]}"
            local name="${SUB_LEADER_NAMES[$i]}"

            if ! start_agent "$role" "$name" "$pane_num"; then
                print_warning "Sub-Leader ${name} の起動に失敗しましたが、続行します"
            fi

            ((pane_num++))
        done

        print_success "Sub-Leaders 起動完了 (${#SUB_LEADERS[@]}名)"
    fi

    # IGNITIANs の起動 (worker_count > 0 かつ agent_mode が full の場合)
    local actual_ignitian_count=0
    if [[ "$worker_count" -gt 0 ]] && [[ "$agent_mode" == "full" ]]; then
        echo ""
        print_header "IGNITIANs 起動"
        echo ""

        # Sub-Leaders の後のペイン番号から開始
        local start_pane=$((1 + ${#SUB_LEADERS[@]}))

        for ((i=1; i<=worker_count; i++)); do
            local pane_num=$((start_pane + i - 1))

            if ! start_ignitian "$i" "$pane_num"; then
                print_warning "IGNITIAN-${i} の起動に失敗しましたが、続行します"
            else
                actual_ignitian_count=$((actual_ignitian_count + 1))
            fi
        done

        print_success "IGNITIANs 起動完了 (${actual_ignitian_count}並列)"
    fi

    # システム設定ファイルを作成（IGNITIANs数などを記録）
    print_info "システム設定を保存中..."
    cat > "$WORKSPACE_DIR/system_config.yaml" <<EOF
# IGNITE システム設定（自動生成）
# このファイルはシステム起動時に自動的に更新されます

system:
  started_at: "$(date -Iseconds)"
  agent_mode: "${agent_mode}"
  session_name: "${SESSION_NAME}"
  workspace_dir: "${WORKSPACE_DIR}"

ignitians:
  count: ${actual_ignitian_count}
  ids: [$(seq -s ', ' 1 ${actual_ignitian_count} 2>/dev/null || echo "")]
EOF

    # コスト追跡用のセッションID記録
    print_info "コスト追跡用のセッション情報を記録中..."
    mkdir -p "$WORKSPACE_DIR/costs/history"

    local started_timestamp=$(date -Iseconds)
    cat > "$WORKSPACE_DIR/costs/sessions.yaml" <<EOF
# IGNITE セッション情報（コスト追跡用）
# このファイルはシステム起動時に自動的に生成されます

session_name: "${SESSION_NAME}"
started_at: "${started_timestamp}"
workspace_dir: "${WORKSPACE_DIR}"

# 各エージェントのClaudeセッションIDは起動後に自動記録されます
# sessions-index.json から起動時刻でマッチングして特定

agents:
EOF

    # エージェントのセッションID記録（起動時刻ベースで推定）
    # Note: 実際のセッションIDは sessions-index.json から起動時刻でマッチング
    local agent_started_at="$started_timestamp"

    # Leader
    cat >> "$WORKSPACE_DIR/costs/sessions.yaml" <<EOF
  leader:
    pane: 0
    name: "伊羽ユイ"
    started_at: "${agent_started_at}"
    session_id: null
EOF

    # Sub-Leaders
    if [[ "$agent_mode" != "leader" ]]; then
        for i in "${!SUB_LEADERS[@]}"; do
            local role="${SUB_LEADERS[$i]}"
            local name="${SUB_LEADER_NAMES[$i]}"
            local pane=$((i + 1))
            cat >> "$WORKSPACE_DIR/costs/sessions.yaml" <<EOF
  ${role}:
    pane: ${pane}
    name: "${name}"
    started_at: "${agent_started_at}"
    session_id: null
EOF
        done
    fi

    # IGNITIANs
    if [[ "$actual_ignitian_count" -gt 0 ]]; then
        echo "" >> "$WORKSPACE_DIR/costs/sessions.yaml"
        echo "ignitians:" >> "$WORKSPACE_DIR/costs/sessions.yaml"
        for ((i=1; i<=actual_ignitian_count; i++)); do
            local pane=$((6 + i - 1))
            cat >> "$WORKSPACE_DIR/costs/sessions.yaml" <<EOF
  ignitian_${i}:
    pane: ${pane}
    started_at: "${agent_started_at}"
    session_id: null
EOF
        done
    fi

    print_success "セッション情報を記録しました"

    echo ""
    print_header "起動完了"
    echo ""
    echo "次のステップ:"
    echo -e "  1. tmuxセッションに接続: ${YELLOW}./scripts/ignite attach${NC}"
    echo -e "  2. ダッシュボード確認: ${YELLOW}./scripts/ignite status${NC}"
    echo -e "  3. タスク投入: ${YELLOW}./scripts/ignite plan \"目標\"${NC}"
    echo ""
    echo "tmuxセッション操作:"
    echo -e "  - デタッチ: ${YELLOW}Ctrl+b d${NC}"
    echo -e "  - セッション終了: ${YELLOW}./scripts/ignite stop${NC}"
    echo ""

    # GitHub Watcher の起動判定
    local start_watcher=false
    if [[ "$with_watcher" == "true" ]]; then
        start_watcher=true
    elif [[ "$with_watcher" == "false" ]]; then
        start_watcher=false
    elif get_watcher_auto_start; then
        start_watcher=true
    fi

    # GitHub Watcher の起動
    if [[ "$start_watcher" == true ]]; then
        if [[ -f "$IGNITE_CONFIG_DIR/github-watcher.yaml" ]]; then
            # 既存のWatcher/モニターをクリーンアップ（前セッションの残骸対策）
            pkill -f "github_watcher.sh" 2>/dev/null || true
            pkill -f "queue_monitor.sh" 2>/dev/null || true
            sleep 1

            print_info "GitHub Watcherを起動中..."
            # ログ出力先を設定してバックグラウンド起動
            local watcher_log="$WORKSPACE_DIR/logs/github_watcher.log"
            "$IGNITE_SCRIPTS_DIR/utils/github_watcher.sh" >> "$watcher_log" 2>&1 &
            local watcher_pid=$!
            echo "$watcher_pid" > "$WORKSPACE_DIR/github_watcher.pid"
            print_success "GitHub Watcher起動完了 (PID: $watcher_pid)"
            print_info "ログ: $watcher_log"

            # キューモニター起動（Watcher有効時のみ）
            # Leaderのキュー監視のため、単独モードでも起動が必要
            print_info "キューモニターを起動中..."
            local queue_log="$WORKSPACE_DIR/logs/queue_monitor.log"
            "$IGNITE_SCRIPTS_DIR/utils/queue_monitor.sh" -s "$SESSION_NAME" >> "$queue_log" 2>&1 &
            local queue_pid=$!
            echo "$queue_pid" > "$WORKSPACE_DIR/queue_monitor.pid"
            print_success "キューモニター起動完了 (PID: $queue_pid)"
            print_info "ログ: $queue_log"
        else
            print_warning "github-watcher.yaml が見つかりません。Watcher起動をスキップ"
        fi
    fi

    # 自動アタッチ
    if [[ "$no_attach" == false ]]; then
        read -p "tmuxセッションにアタッチしますか? (Y/n): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            tmux attach -t "$SESSION_NAME"
        fi
    fi
}

# =============================================================================
# activate コマンド - 各エージェントにコマンドを再送信
# =============================================================================
cmd_activate() {
    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -h|--help) cmd_help activate; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help activate; exit 1 ;;
        esac
    done

    # セッション名を設定
    setup_session_name

    if ! session_exists; then
        print_error "セッション '$SESSION_NAME' が見つかりません"
        echo ""
        print_info "実行中のセッション一覧:"
        list_sessions 2>/dev/null || true
        exit 1
    fi

    print_header "エージェントをアクティベート中"
    echo ""
    echo -e "${BLUE}セッション:${NC} $SESSION_NAME"
    echo ""

    # ペイン数を確認
    local pane_count
    pane_count=$(tmux list-panes -t "$SESSION_NAME" 2>/dev/null | wc -l)

    print_info "検出されたペイン数: $pane_count"

    # 各paneに対してEnterを送信して、入力待ちのコマンドを実行
    for ((i=1; i<pane_count; i++)); do
        print_info "pane $i をアクティベート中..."
        tmux send-keys -t "$SESSION_NAME:ignite.$i" Enter
        sleep 1
    done

    print_success "全エージェントにアクティベーション信号を送信しました"
    echo ""
    echo "各エージェントがシステムプロンプトを読み込んでいます。"
    echo -e "状態確認: ${YELLOW}./scripts/ignite status -s $SESSION_NAME${NC}"
}

# =============================================================================
# notify コマンド - 特定のエージェントにメッセージを送信
# =============================================================================
cmd_notify() {
    local target=""
    local message=""

    # 引数解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -w|--workspace)
                WORKSPACE_DIR="$2"
                if [[ ! "$WORKSPACE_DIR" = /* ]]; then
                    WORKSPACE_DIR="$(pwd)/$WORKSPACE_DIR"
                fi
                shift 2
                ;;
            -h|--help) cmd_help notify; exit 0 ;;
            *)
                if [[ -z "$target" ]]; then
                    target="$1"
                elif [[ -z "$message" ]]; then
                    message="$1"
                fi
                shift
                ;;
        esac
    done

    # セッション名とワークスペースを設定
    setup_session_name
    setup_workspace

    if [[ -z "$target" ]] || [[ -z "$message" ]]; then
        print_error "ターゲットとメッセージを指定してください"
        echo "使用方法: ./scripts/ignite notify <target> \"message\""
        echo "ターゲット: leader, strategist, architect, evaluator, coordinator, innovator, ignitians"
        exit 1
    fi

    if ! session_exists; then
        print_error "セッション '$SESSION_NAME' が見つかりません"
        echo ""
        print_info "実行中のセッション一覧:"
        list_sessions 2>/dev/null || true
        exit 1
    fi

    cd "$WORKSPACE_DIR"

    # メッセージファイル作成
    local timestamp=$(date -Iseconds)
    local message_id=$(date +%s%N)
    local message_file="$WORKSPACE_DIR/queue/${target}/notify_${message_id}.yaml"

    mkdir -p "$WORKSPACE_DIR/queue/${target}"

    cat > "$message_file" <<EOF
type: notification
from: user
to: ${target}
timestamp: "${timestamp}"
priority: normal
payload:
  message: "${message}"
status: pending
EOF

    print_success "メッセージを送信しました: $message_file"

    # ペイン番号を特定して通知
    local pane_num=0
    case "$target" in
        leader) pane_num=0 ;;
        strategist) pane_num=1 ;;
        architect) pane_num=2 ;;
        evaluator) pane_num=3 ;;
        coordinator) pane_num=4 ;;
        innovator) pane_num=5 ;;
        ignitians) pane_num=6 ;;  # 最初のIGNITIANに送信
    esac

    tmux send-keys -t "$SESSION_NAME:ignite.$pane_num" \
        "$WORKSPACE_DIR/queue/${target}/ に新しいメッセージがあります。確認してください。" Enter

    print_success "pane $pane_num に通知を送信しました"
}

# =============================================================================
# stop コマンド
# =============================================================================
cmd_stop() {
    local skip_confirm=false

    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -y|--yes) skip_confirm=true; shift ;;
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -h|--help) cmd_help stop; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help stop; exit 1 ;;
        esac
    done

    # セッション名を設定
    setup_session_name

    print_header "IGNITE システム停止"
    echo ""
    echo -e "${BLUE}対象セッション:${NC} $SESSION_NAME"
    echo ""

    # セッションの存在確認
    if ! session_exists; then
        print_error "セッション '$SESSION_NAME' が見つかりません"
        echo ""
        print_info "実行中のセッション一覧:"
        list_sessions 2>/dev/null || true
        exit 1
    fi

    # 確認
    if [[ "$skip_confirm" == false ]]; then
        read -p "IGNITE システムを停止しますか? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_warning "キャンセルしました"
            exit 0
        fi
    fi

    # ワークスペースを設定
    setup_workspace

    # GitHub Watcher を停止
    if [[ -f "$WORKSPACE_DIR/github_watcher.pid" ]]; then
        local watcher_pid=$(cat "$WORKSPACE_DIR/github_watcher.pid")
        if kill -0 "$watcher_pid" 2>/dev/null; then
            print_info "GitHub Watcherを停止中..."
            kill "$watcher_pid" 2>/dev/null || true
            print_success "GitHub Watcher停止完了"
        fi
        rm -f "$WORKSPACE_DIR/github_watcher.pid"
    fi

    # キューモニターを停止
    if [[ -f "$WORKSPACE_DIR/queue_monitor.pid" ]]; then
        local queue_pid=$(cat "$WORKSPACE_DIR/queue_monitor.pid")
        if kill -0 "$queue_pid" 2>/dev/null; then
            print_info "キューモニターを停止中..."
            kill "$queue_pid" 2>/dev/null || true
            print_success "キューモニター停止完了"
        fi
        rm -f "$WORKSPACE_DIR/queue_monitor.pid"
    fi

    # コスト履歴を保存
    save_cost_history

    # セッション終了
    print_warning "tmuxセッションを終了中..."
    tmux kill-session -t "$SESSION_NAME"

    print_success "IGNITE システムを停止しました"
}

# コスト履歴を保存する関数
save_cost_history() {
    local sessions_file="$WORKSPACE_DIR/costs/sessions.yaml"

    if [[ ! -f "$sessions_file" ]]; then
        print_warning "セッション情報が見つかりません。コスト履歴はスキップします。"
        return
    fi

    print_info "コスト履歴を保存中..."

    # 料金設定を読み込む
    load_pricing || return

    local session_name=$(grep "^session_name:" "$sessions_file" | awk '{print $2}' | tr -d '"')
    local started_at=$(grep "^started_at:" "$sessions_file" | awk '{print $2}' | tr -d '"')
    local stopped_at=$(date -Iseconds)
    local date_suffix=$(date +%Y-%m-%d)

    local history_file="$WORKSPACE_DIR/costs/history/${session_name}_${date_suffix}.yaml"
    mkdir -p "$WORKSPACE_DIR/costs/history"

    # エージェント定義
    local -a agents=("leader" "strategist" "architect" "evaluator" "coordinator" "innovator")

    # 履歴ファイルの作成開始
    cat > "$history_file" <<EOF
# IGNITE コスト履歴
# 自動生成: $(date -Iseconds)

session_name: "${session_name}"
started_at: "${started_at}"
stopped_at: "${stopped_at}"

agents:
EOF

    local total_input=0
    local total_output=0
    local total_cost=0

    # 各エージェントのコストを記録
    for role in "${agents[@]}"; do
        local session_id=$(get_agent_session_id "$role")
        if [[ -n "$session_id" ]] && [[ "$session_id" != "null" ]]; then
            local tokens=$(collect_session_tokens "$session_id")
            local input=$(echo "$tokens" | jq -r '.input')
            local output=$(echo "$tokens" | jq -r '.output')
            local cache_read=$(echo "$tokens" | jq -r '.cache_read')
            local cache_creation=$(echo "$tokens" | jq -r '.cache_creation')
            local cost=$(calculate_cost "$input" "$output" "$cache_read" "$cache_creation")

            cat >> "$history_file" <<EOF
  ${role}:
    session_id: "${session_id}"
    input_tokens: ${input}
    output_tokens: ${output}
    cache_read_tokens: ${cache_read}
    cache_creation_tokens: ${cache_creation}
    cost_usd: ${cost}
EOF

            total_input=$((total_input + input))
            total_output=$((total_output + output))
            total_cost=$(echo "$total_cost + $cost" | bc)
        fi
    done

    # IGNITIANsのコストを記録
    local ignitian_total_input=0
    local ignitian_total_output=0
    local ignitian_total_cost=0
    local ignitian_count=0

    echo "" >> "$history_file"
    echo "ignitians:" >> "$history_file"

    local in_ignitians=false
    local current_ignitian=""
    while IFS= read -r line; do
        if [[ "$line" =~ ^[[:space:]]*ignitians: ]]; then
            in_ignitians=true
            continue
        fi
        if [[ "$in_ignitians" == true ]]; then
            if [[ "$line" =~ ^[[:space:]]*ignitian_([0-9]+): ]]; then
                current_ignitian="ignitian_${BASH_REMATCH[1]}"
                ignitian_count=$((ignitian_count + 1))
            elif [[ "$line" =~ ^[[:space:]]*session_id:[[:space:]]*\"?([^\"]+)\"? ]] && [[ -n "$current_ignitian" ]]; then
                local session_id="${BASH_REMATCH[1]}"
                if [[ -n "$session_id" ]] && [[ "$session_id" != "null" ]]; then
                    local tokens=$(collect_session_tokens "$session_id")
                    local input=$(echo "$tokens" | jq -r '.input')
                    local output=$(echo "$tokens" | jq -r '.output')
                    local cache_read=$(echo "$tokens" | jq -r '.cache_read')
                    local cache_creation=$(echo "$tokens" | jq -r '.cache_creation')
                    local cost=$(calculate_cost "$input" "$output" "$cache_read" "$cache_creation")

                    cat >> "$history_file" <<EOF
  ${current_ignitian}:
    session_id: "${session_id}"
    input_tokens: ${input}
    output_tokens: ${output}
    cache_read_tokens: ${cache_read}
    cache_creation_tokens: ${cache_creation}
    cost_usd: ${cost}
EOF

                    ignitian_total_input=$((ignitian_total_input + input))
                    ignitian_total_output=$((ignitian_total_output + output))
                    ignitian_total_cost=$(echo "$ignitian_total_cost + $cost" | bc)
                fi
                current_ignitian=""
            elif [[ "$line" =~ ^[a-z]+: ]]; then
                # インデントなしの新しいセクションが始まったら終了
                in_ignitians=false
            fi
        fi
    done < "$sessions_file"

    # 全体の合計
    total_input=$((total_input + ignitian_total_input))
    total_output=$((total_output + ignitian_total_output))
    total_cost=$(echo "$total_cost + $ignitian_total_cost" | bc)

    cat >> "$history_file" <<EOF

total:
  input_tokens: ${total_input}
  output_tokens: ${total_output}
  cost_usd: ${total_cost}
  ignitians_count: ${ignitian_count}
EOF

    print_success "コスト履歴を保存しました: $history_file"
}

# =============================================================================
# plan コマンド
# =============================================================================
cmd_plan() {
    local goal=""
    local context=""

    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -c|--context) context="$2"; shift 2 ;;
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -w|--workspace)
                WORKSPACE_DIR="$2"
                if [[ ! "$WORKSPACE_DIR" = /* ]]; then
                    WORKSPACE_DIR="$(pwd)/$WORKSPACE_DIR"
                fi
                shift 2
                ;;
            -h|--help) cmd_help plan; exit 0 ;;
            -*) print_error "Unknown option: $1"; cmd_help plan; exit 1 ;;
            *)
                if [[ -z "$goal" ]]; then
                    goal="$1"
                    shift
                else
                    print_error "引数が多すぎます"
                    cmd_help plan
                    exit 1
                fi
                ;;
        esac
    done

    # セッション名とワークスペースを設定
    setup_session_name
    setup_workspace

    # 引数チェック
    if [[ -z "$goal" ]]; then
        print_error "目標を指定してください"
        echo ""
        echo "使用方法:"
        echo "  ./scripts/ignite plan \"目標の内容\""
        echo "  ./scripts/ignite plan \"目標\" -c \"コンテキスト\""
        echo ""
        echo "例:"
        echo "  ./scripts/ignite plan \"READMEファイルを作成する\""
        echo "  ./scripts/ignite plan \"認証機能を実装\" -c \"JWT認証、セッション管理\""
        exit 1
    fi

    cd "$WORKSPACE_DIR"

    # セッションの存在確認
    if ! session_exists; then
        print_error "セッション '$SESSION_NAME' が見つかりません"
        echo ""
        print_info "実行中のセッション一覧:"
        list_sessions 2>/dev/null || true
        echo -e "${YELLOW}先に起動してください: ./scripts/ignite start${NC}"
        exit 1
    fi

    print_header "IGNITE タスク投入"
    echo ""
    echo -e "${BLUE}目標:${NC} $goal"
    if [[ -n "$context" ]]; then
        echo -e "${BLUE}コンテキスト:${NC} $context"
    fi
    echo ""

    # タイムスタンプとメッセージID生成
    local timestamp=$(date -Iseconds)
    local message_id=$(date +%s)

    # Leaderへメッセージ送信
    local message_file="$WORKSPACE_DIR/queue/leader/user_goal_${message_id}.yaml"

    if [[ -n "$context" ]]; then
        cat > "$message_file" <<EOF
type: user_goal
from: user
to: leader
timestamp: "${timestamp}"
priority: high
payload:
  goal: "${goal}"
  context: "${context}"
status: pending
EOF
    else
        cat > "$message_file" <<EOF
type: user_goal
from: user
to: leader
timestamp: "${timestamp}"
priority: high
payload:
  goal: "${goal}"
status: pending
EOF
    fi

    print_success "メッセージを作成しました: $message_file"

    # Leaderに通知（自然言語プロンプトで送信）- pane 0 を明示的に指定
    sleep 0.5
    tmux send-keys -t "$SESSION_NAME:ignite.0" \
        "$WORKSPACE_DIR/queue/leader/ に新しいメッセージがあります。${message_file} を確認して処理してください。目標: ${goal}"
    sleep 0.3
    tmux send-keys -t "$SESSION_NAME:ignite.0" C-m

    echo ""
    print_success "タスク '${goal}' を投入しました"
    echo ""
    echo "次のステップ:"
    echo -e "  1. ダッシュボード確認: ${YELLOW}./scripts/ignite status${NC}"
    echo -e "  2. ログ確認: ${YELLOW}./scripts/ignite logs${NC}"
    echo -e "  3. tmuxセッション表示: ${YELLOW}./scripts/ignite attach${NC}"
}

# =============================================================================
# status コマンド
# =============================================================================
cmd_status() {
    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -w|--workspace)
                WORKSPACE_DIR="$2"
                if [[ ! "$WORKSPACE_DIR" = /* ]]; then
                    WORKSPACE_DIR="$(pwd)/$WORKSPACE_DIR"
                fi
                shift 2
                ;;
            -h|--help) cmd_help status; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help status; exit 1 ;;
        esac
    done

    # セッション名とワークスペースを設定
    setup_session_name
    setup_workspace

    cd "$WORKSPACE_DIR"

    print_header "IGNITE システム状態"
    echo ""
    echo -e "${BLUE}セッション:${NC} $SESSION_NAME"
    echo -e "${BLUE}ワークスペース:${NC} $WORKSPACE_DIR"
    echo ""

    # tmuxセッション確認
    if session_exists; then
        print_success "tmuxセッション: 実行中"

        # ペイン数確認
        local pane_count
        pane_count=$(tmux list-panes -t "$SESSION_NAME" 2>/dev/null | wc -l)
        echo -e "${BLUE}  ペイン数: ${pane_count}${NC}"

        # エージェント構成の推定
        echo ""
        print_header "エージェント状態"
        echo ""
        echo -e "  ${GREEN}✓${NC} pane 0: Leader (伊羽ユイ)"

        if [[ "$pane_count" -gt 1 ]]; then
            local sub_count=$((pane_count > 6 ? 5 : pane_count - 1))
            for i in $(seq 1 $sub_count); do
                local idx=$((i - 1))
                if [[ $idx -lt ${#SUB_LEADERS[@]} ]]; then
                    echo -e "  ${GREEN}✓${NC} pane ${i}: ${SUB_LEADER_NAMES[$idx]} (${SUB_LEADERS[$idx]})"
                fi
            done
        fi

        if [[ "$pane_count" -gt 6 ]]; then
            local ignitian_count=$((pane_count - 6))
            for i in $(seq 1 $ignitian_count); do
                local pane_num=$((5 + i))
                echo -e "  ${GREEN}✓${NC} pane ${pane_num}: IGNITIAN-${i}"
            done
        fi
    else
        print_error "tmuxセッション: 停止"
        exit 1
    fi

    echo ""

    # ダッシュボード表示
    if [[ -f "$WORKSPACE_DIR/dashboard.md" ]]; then
        print_header "ダッシュボード"
        echo ""
        cat "$WORKSPACE_DIR/dashboard.md"
        echo ""
    else
        print_warning "ダッシュボードが見つかりません"
    fi

    # キュー状態
    print_header "キュー状態"
    echo ""

    for queue_dir in "$WORKSPACE_DIR/queue"/*; do
        if [[ -d "$queue_dir" ]]; then
            local queue_name=$(basename "$queue_dir")
            local message_count=$(find "$queue_dir" -name "*.yaml" -type f 2>/dev/null | wc -l)

            if [[ "$message_count" -gt 0 ]]; then
                echo -e "${YELLOW}  $queue_name: $message_count メッセージ${NC}"
            else
                echo -e "${GREEN}  $queue_name: 0 メッセージ${NC}"
            fi
        fi
    done

    echo ""

    # レポート状態
    if [[ -d "$WORKSPACE_DIR/reports" ]]; then
        local report_count=$(find "$WORKSPACE_DIR/reports" -name "*.yaml" -type f 2>/dev/null | wc -l)
        print_header "レポート"
        echo "  完了レポート: ${report_count} 件"
        echo ""
    fi

    # GitHub Watcher状態
    print_header "GitHub Watcher"
    if [[ -f "$WORKSPACE_DIR/github_watcher.pid" ]]; then
        local watcher_pid=$(cat "$WORKSPACE_DIR/github_watcher.pid")
        if kill -0 "$watcher_pid" 2>/dev/null; then
            print_success "GitHub Watcher: 実行中 (PID: $watcher_pid)"
        else
            print_warning "GitHub Watcher: 停止（PIDファイルあり）"
        fi
    else
        print_info "GitHub Watcher: 未起動"
    fi

    # キューモニター状態
    print_header "キューモニター"
    if [[ -f "$WORKSPACE_DIR/queue_monitor.pid" ]]; then
        local queue_pid=$(cat "$WORKSPACE_DIR/queue_monitor.pid")
        if kill -0 "$queue_pid" 2>/dev/null; then
            print_success "キューモニター: 実行中 (PID: $queue_pid)"
        else
            print_warning "キューモニター: 停止（PIDファイルあり）"
        fi
    else
        print_info "キューモニター: 未起動"
    fi
    echo ""

    # 最新ログ
    print_header "最新ログ (直近5件)"
    echo ""

    if [[ -d "$WORKSPACE_DIR/logs" ]] && [[ "$(ls -A "$WORKSPACE_DIR/logs" 2>/dev/null)" ]]; then
        for log_file in "$WORKSPACE_DIR/logs"/*.log; do
            if [[ -f "$log_file" ]]; then
                echo -e "${BLUE}$(basename "$log_file"):${NC}"
                tail -n 5 "$log_file" 2>/dev/null | sed 's/^/  /'
                echo ""
            fi
        done
    else
        print_warning "ログファイルなし"
        echo ""
    fi

    print_header "コマンド"
    echo -e "  ダッシュボード監視: ${YELLOW}watch -n 5 cat $WORKSPACE_DIR/dashboard.md${NC}"
    echo -e "  tmuxアタッチ: ${YELLOW}./scripts/ignite attach -s $SESSION_NAME${NC}"
    echo -e "  システム停止: ${YELLOW}./scripts/ignite stop -s $SESSION_NAME${NC}"
}

# =============================================================================
# attach コマンド
# =============================================================================
cmd_attach() {
    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -h|--help) cmd_help attach; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help attach; exit 1 ;;
        esac
    done

    # セッション名を設定
    setup_session_name

    if ! session_exists; then
        print_error "セッション '$SESSION_NAME' が見つかりません"
        echo ""
        print_info "実行中のセッション一覧:"
        list_sessions 2>/dev/null || true
        echo -e "${YELLOW}先に起動してください: ./scripts/ignite start${NC}"
        exit 1
    fi

    tmux attach -t "$SESSION_NAME"
}

# =============================================================================
# logs コマンド
# =============================================================================
cmd_logs() {
    local follow=false
    local lines=20

    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--follow) follow=true; shift ;;
            -n|--lines) lines="$2"; shift 2 ;;
            -w|--workspace)
                WORKSPACE_DIR="$2"
                if [[ ! "$WORKSPACE_DIR" = /* ]]; then
                    WORKSPACE_DIR="$(pwd)/$WORKSPACE_DIR"
                fi
                shift 2
                ;;
            -h|--help) cmd_help logs; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help logs; exit 1 ;;
        esac
    done

    # ワークスペースを設定
    setup_workspace

    cd "$WORKSPACE_DIR"

    if [[ ! -d "$WORKSPACE_DIR/logs" ]] || [[ -z "$(ls -A "$WORKSPACE_DIR/logs" 2>/dev/null)" ]]; then
        print_warning "ログファイルが見つかりません"
        exit 0
    fi

    if [[ "$follow" == true ]]; then
        print_info "ログをリアルタイム監視中... (Ctrl+C で終了)"
        tail -f "$WORKSPACE_DIR/logs"/*.log 2>/dev/null
    else
        print_header "ログ (直近${lines}行)"
        echo ""
        for log_file in "$WORKSPACE_DIR/logs"/*.log; do
            if [[ -f "$log_file" ]]; then
                echo -e "${BLUE}=== $(basename "$log_file") ===${NC}"
                tail -n "$lines" "$log_file" 2>/dev/null
                echo ""
            fi
        done
    fi
}

# =============================================================================
# clean コマンド
# =============================================================================
cmd_clean() {
    local skip_confirm=false

    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -y|--yes) skip_confirm=true; shift ;;
            -w|--workspace)
                WORKSPACE_DIR="$2"
                if [[ ! "$WORKSPACE_DIR" = /* ]]; then
                    WORKSPACE_DIR="$(pwd)/$WORKSPACE_DIR"
                fi
                shift 2
                ;;
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -h|--help) cmd_help clean; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help clean; exit 1 ;;
        esac
    done

    # セッション名とワークスペースを設定
    setup_session_name
    setup_workspace

    cd "$WORKSPACE_DIR"

    print_header "IGNITE workspaceクリア"
    echo ""
    echo -e "${BLUE}ワークスペース:${NC} $WORKSPACE_DIR"
    echo ""

    # セッションが実行中の場合は警告
    if session_exists; then
        print_warning "セッション '$SESSION_NAME' が実行中です"
        echo "先にシステムを停止することをお勧めします: ./scripts/ignite stop -s $SESSION_NAME"
        echo ""
    fi

    # 確認
    if [[ "$skip_confirm" == false ]]; then
        echo "以下のディレクトリがクリアされます:"
        echo "  - $WORKSPACE_DIR/queue/*"
        echo "  - $WORKSPACE_DIR/reports/*"
        echo "  - $WORKSPACE_DIR/logs/*"
        echo "  - $WORKSPACE_DIR/context/*"
        echo "  - $WORKSPACE_DIR/state/*"
        echo "  - $WORKSPACE_DIR/archive/*"
        echo "  - $WORKSPACE_DIR/costs/sessions.yaml"
        echo "  - $WORKSPACE_DIR/dashboard.md"
        echo "  - $WORKSPACE_DIR/system_config.yaml"
        echo "  - $WORKSPACE_DIR/coordinator_state.yaml"
        echo ""
        echo -e "${YELLOW}注意: costs/history/ はクリアされません（履歴保持）${NC}"
        echo ""
        read -p "続行しますか? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_warning "キャンセルしました"
            exit 0
        fi
    fi

    # クリーンアップ実行
    print_info "workspaceをクリア中..."

    rm -rf "$WORKSPACE_DIR/queue"/*/
    mkdir -p "$WORKSPACE_DIR/queue"/{leader,strategist,architect,evaluator,coordinator,innovator,ignitians}

    rm -rf "$WORKSPACE_DIR/reports"/*
    rm -rf "$WORKSPACE_DIR/logs"/*
    rm -rf "$WORKSPACE_DIR/context"/*
    rm -f "$WORKSPACE_DIR/dashboard.md"
    rm -f "$WORKSPACE_DIR/system_config.yaml"
    rm -f "$WORKSPACE_DIR/coordinator_state.yaml"
    rm -rf "$WORKSPACE_DIR/state"/*
    rm -rf "$WORKSPACE_DIR/archive"/*
    mkdir -p "$WORKSPACE_DIR/archive"/{leader,strategist,coordinator}

    # コストのセッション情報をクリア（履歴は保持）
    rm -f "$WORKSPACE_DIR/costs/sessions.yaml"

    print_success "workspaceをクリアしました"
}

# =============================================================================
# cost コマンド - トークン消費量と費用を表示
# =============================================================================

# 料金設定を読み込む
load_pricing() {
    local pricing_file="$IGNITE_CONFIG_DIR/pricing.yaml"
    if [[ ! -f "$pricing_file" ]]; then
        print_error "料金設定ファイルが見つかりません: $pricing_file"
        return 1
    fi

    # デフォルトモデルの料金を取得
    PRICE_INPUT=$(grep -A5 "claude-opus-4-5-20251101:" "$pricing_file" | grep "input_per_1m_tokens:" | awk '{print $2}')
    PRICE_OUTPUT=$(grep -A5 "claude-opus-4-5-20251101:" "$pricing_file" | grep "output_per_1m_tokens:" | awk '{print $2}')
    PRICE_CACHE_READ=$(grep -A5 "claude-opus-4-5-20251101:" "$pricing_file" | grep "cache_read_per_1m_tokens:" | awk '{print $2}')
    PRICE_CACHE_CREATE=$(grep -A5 "claude-opus-4-5-20251101:" "$pricing_file" | grep "cache_creation_per_1m_tokens:" | awk '{print $2}')
    EXCHANGE_RATE=$(grep "exchange_rate_jpy:" "$pricing_file" | awk '{print $2}')

    # デフォルト値 (Claude Opus 4.5)
    PRICE_INPUT=${PRICE_INPUT:-5.00}
    PRICE_OUTPUT=${PRICE_OUTPUT:-25.00}
    PRICE_CACHE_READ=${PRICE_CACHE_READ:-0.50}
    PRICE_CACHE_CREATE=${PRICE_CACHE_CREATE:-6.25}
    EXCHANGE_RATE=${EXCHANGE_RATE:-150.0}
}

# セッションIDからトークン使用量を集計
collect_session_tokens() {
    local session_id="$1"
    local session_file="$CLAUDE_PROJECTS_DIR/${session_id}.jsonl"
    local session_dir="$CLAUDE_PROJECTS_DIR/${session_id}"

    # 集計対象ファイル
    local files=()
    if [[ -f "$session_file" ]]; then
        files+=("$session_file")
    fi
    # サブエージェントのファイルも含める
    if [[ -d "$session_dir/subagents" ]]; then
        while IFS= read -r -d '' f; do
            files+=("$f")
        done < <(find "$session_dir/subagents" -name "*.jsonl" -print0 2>/dev/null)
    fi

    if [[ ${#files[@]} -eq 0 ]]; then
        echo '{"input":0,"output":0,"cache_read":0,"cache_creation":0}'
        return
    fi

    # jqで集計
    cat "${files[@]}" 2>/dev/null | jq -s '
      [.[] | select(.type == "assistant" and .message.usage != null) | .message.usage]
      | {
          input: (map(.input_tokens // 0) | add // 0),
          output: (map(.output_tokens // 0) | add // 0),
          cache_read: (map(.cache_read_input_tokens // 0) | add // 0),
          cache_creation: (map(.cache_creation_input_tokens // 0) | add // 0)
        }
    '
}

# トークン数を人間が読みやすい形式に変換
format_tokens() {
    local tokens="$1"
    if [[ "$tokens" -ge 1000000 ]]; then
        printf "%.1fM" "$(echo "scale=1; $tokens / 1000000" | bc)"
    elif [[ "$tokens" -ge 1000 ]]; then
        printf "%.1fK" "$(echo "scale=1; $tokens / 1000" | bc)"
    else
        echo "$tokens"
    fi
}

# トークン数をカンマ区切りでフォーマット
format_number() {
    local num="$1"
    printf "%'d" "$num" 2>/dev/null || echo "$num"
}

# 文字列の表示幅を計算（全角文字=2, 半角文字=1）
get_display_width() {
    local str="$1"
    # wc -L はターミナルの表示幅を正しく計算する（ヒアストリングで渡す）
    local width=$(wc -L <<< "$str")
    echo "$width"
}

# 指定した表示幅になるよう右パディング
pad_right() {
    local str="$1"
    local target_width="$2"
    local current_width=$(get_display_width "$str")
    local padding=$((target_width - current_width))
    if [[ $padding -lt 0 ]]; then padding=0; fi
    printf "%s%*s" "$str" "$padding" ""
}

# 指定した表示幅になるよう左パディング（右寄せ）
pad_left() {
    local str="$1"
    local target_width="$2"
    local current_width=$(get_display_width "$str")
    local padding=$((target_width - current_width))
    if [[ $padding -lt 0 ]]; then padding=0; fi
    printf "%*s%s" "$padding" "" "$str"
}

# コストを計算（ドル）
calculate_cost() {
    local input="$1"
    local output="$2"
    local cache_read="$3"
    local cache_creation="$4"

    # 百万トークンあたりの価格で計算
    echo "scale=4; ($input * $PRICE_INPUT / 1000000) + ($output * $PRICE_OUTPUT / 1000000) + ($cache_read * $PRICE_CACHE_READ / 1000000) + ($cache_creation * $PRICE_CACHE_CREATE / 1000000)" | bc
}

# sessions-index.json から起動時刻以降のセッションを検索
find_sessions_after_time() {
    local after_time="$1"  # ISO 8601 形式
    local sessions_index="$CLAUDE_PROJECTS_DIR/sessions-index.json"

    if [[ ! -f "$sessions_index" ]]; then
        return 1
    fi

    jq -r --arg after "$after_time" '
      .entries[]
      | select(.created >= $after)
      | .sessionId
    ' "$sessions_index"
}

# エージェント役割からsessions-index.jsonを検索してセッションIDを解決
resolve_agent_session_id() {
    local agent_role="$1"
    local started_at="$2"
    local sessions_index="$CLAUDE_PROJECTS_DIR/sessions-index.json"

    [[ ! -f "$sessions_index" ]] && return 1

    local pattern=""
    case "$agent_role" in
        leader|strategist|architect|evaluator|coordinator|innovator)
            # セッション履歴内で指示ファイルのパターンを検索
            pattern="${agent_role}\\.md.*として振る舞って"
            ;;
        ignitian_*)
            local num="${agent_role#ignitian_}"
            pattern="IGNITIAN-${num}"
            ;;
        *) return 1 ;;
    esac

    # まずsessions-index.jsonから検索
    local session_id=$(jq -r --arg after "$started_at" --arg pattern "$pattern" '
      .entries
      | map(select(.created >= $after and (.firstPrompt | test($pattern))))
      | sort_by(.created) | last | .sessionId // empty
    ' "$sessions_index" 2>/dev/null)

    if [[ -n "$session_id" ]]; then
        echo "$session_id"
        return 0
    fi

    # インデックスに見つからない場合、セッションファイルを直接検索
    local project_dir=$(dirname "$sessions_index")
    for f in "$project_dir"/*.jsonl; do
        [[ -f "$f" ]] || continue
        # ファイルの更新時刻が開始時刻より後かチェック
        local file_mtime=$(stat -c %Y "$f" 2>/dev/null)
        local start_epoch=$(date -d "$started_at" +%s 2>/dev/null)
        [[ -z "$file_mtime" ]] || [[ -z "$start_epoch" ]] && continue
        [[ $file_mtime -lt $start_epoch ]] && continue

        # firstPromptにパターンが含まれるか確認
        if head -5 "$f" 2>/dev/null | grep -q "$pattern"; then
            basename "$f" .jsonl
            return 0
        fi
    done
}

# sessions.yamlのsession_idがnullのエージェントを自動解決
update_sessions_yaml() {
    local sessions_file="$WORKSPACE_DIR/costs/sessions.yaml"

    [[ ! -f "$sessions_file" ]] && return 1

    local started_at=$(grep "^started_at:" "$sessions_file" | awk '{print $2}' | tr -d '"')
    [[ -z "$started_at" ]] && return 1

    # ISO 8601形式の開始時刻をUTCに変換（sessions-index.jsonはUTC）
    # エージェント起動はsessions.yamlのstarted_atより前に行われるため、3分前からを検索対象とする
    local started_utc=$(date -u -d "$started_at - 3 minutes" +"%Y-%m-%dT%H:%M:%S" 2>/dev/null)
    [[ -z "$started_utc" ]] && return 1

    local updated=false

    # Sub-Leaders のセッションID解決
    for role in leader strategist architect evaluator coordinator innovator; do
        local current_id=$(grep -A5 "^  ${role}:" "$sessions_file" 2>/dev/null | grep "session_id:" | head -1 | awk '{print $2}' | tr -d '"')
        if [[ -z "$current_id" ]] || [[ "$current_id" == "null" ]]; then
            local resolved_id=$(resolve_agent_session_id "$role" "$started_utc")
            if [[ -n "$resolved_id" ]]; then
                sed -i "/^  ${role}:/,/session_id:/{s/session_id: null/session_id: \"$resolved_id\"/}" "$sessions_file"
                updated=true
            fi
        fi
    done

    # IGNITIANs のセッションID解決
    for i in 1 2 3 4 5 6; do
        local role="ignitian_$i"
        if grep -q "^  ${role}:" "$sessions_file"; then
            local current_id=$(grep -A3 "^  ${role}:" "$sessions_file" 2>/dev/null | grep "session_id:" | head -1 | awk '{print $2}' | tr -d '"')
            if [[ -z "$current_id" ]] || [[ "$current_id" == "null" ]]; then
                local resolved_id=$(resolve_agent_session_id "$role" "$started_utc")
                if [[ -n "$resolved_id" ]]; then
                    sed -i "/^  ${role}:/,/session_id:/{s/session_id: null/session_id: \"$resolved_id\"/}" "$sessions_file"
                    updated=true
                fi
            fi
        fi
    done

    [[ "$updated" == true ]]
}

# エージェント名からセッションIDを取得
get_agent_session_id() {
    local agent_role="$1"
    local sessions_file="$WORKSPACE_DIR/costs/sessions.yaml"

    if [[ ! -f "$sessions_file" ]]; then
        return 1
    fi

    # session_id は role: の後 4行以内にある
    grep -A5 "^  ${agent_role}:" "$sessions_file" 2>/dev/null | grep "session_id:" | head -1 | awk '{print $2}' | tr -d '"'
}

# コスト一覧を表示（セッション履歴）
list_cost_sessions() {
    local history_dir="$WORKSPACE_DIR/costs/history"

    print_header "コスト履歴一覧"
    echo ""

    if [[ ! -d "$history_dir" ]] || [[ -z "$(ls -A "$history_dir" 2>/dev/null)" ]]; then
        print_warning "履歴がありません"
        echo ""
        echo "現在のセッションのコストを確認するには:"
        echo -e "  ${YELLOW}./scripts/ignite cost${NC}"
        return
    fi

    echo "セッション名              開始日時              合計費用"
    echo "────────────────────────────────────────────────────────"

    for file in "$history_dir"/*.yaml; do
        if [[ -f "$file" ]]; then
            local name=$(grep "^session_name:" "$file" | awk '{print $2}' | tr -d '"')
            local started=$(grep "^started_at:" "$file" | awk '{print $2}' | tr -d '"' | cut -d'T' -f1,2 | tr 'T' ' ')
            local cost=$(grep -A3 "^total:" "$file" | grep "cost_usd:" | awk '{print $2}')
            printf "%-24s %-20s \$%.2f\n" "$name" "$started" "$cost"
        fi
    done

    echo ""
    echo "詳細を表示:"
    echo -e "  ${YELLOW}./scripts/ignite cost -s <session-name>${NC}"
}

cmd_cost() {
    local target_session=""
    local target_agent=""
    local detailed=false
    local json_output=false
    local list_mode=false

    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s|--session)
                target_session="$2"
                if [[ ! "$target_session" =~ ^ignite- ]]; then
                    target_session="ignite-$target_session"
                fi
                shift 2
                ;;
            -a|--agent)
                target_agent="$2"
                shift 2
                ;;
            -d|--detailed)
                detailed=true
                shift
                ;;
            -j|--json)
                json_output=true
                shift
                ;;
            -l|--list)
                list_mode=true
                shift
                ;;
            -w|--workspace)
                WORKSPACE_DIR="$2"
                if [[ ! "$WORKSPACE_DIR" = /* ]]; then
                    WORKSPACE_DIR="$(pwd)/$WORKSPACE_DIR"
                fi
                shift 2
                ;;
            -h|--help) cmd_help cost; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help cost; exit 1 ;;
        esac
    done

    # ワークスペースを設定
    setup_workspace

    # session_id が null のエージェントがあれば自動解決を試みる
    update_sessions_yaml 2>/dev/null || true

    # 一覧モード
    if [[ "$list_mode" == true ]]; then
        list_cost_sessions
        return 0
    fi

    # 料金設定を読み込む
    load_pricing || exit 1

    # セッション情報の取得元を決定
    local sessions_file="$WORKSPACE_DIR/costs/sessions.yaml"
    local started_at=""

    if [[ -n "$target_session" ]]; then
        # 履歴から検索
        local history_file="$WORKSPACE_DIR/costs/history/${target_session}.yaml"
        if [[ -f "$history_file" ]]; then
            sessions_file="$history_file"
            started_at=$(grep "^started_at:" "$history_file" | awk '{print $2}' | tr -d '"')
        else
            # 現在のセッションファイルを確認
            if [[ -f "$sessions_file" ]]; then
                local current_session=$(grep "^session_name:" "$sessions_file" | awk '{print $2}' | tr -d '"')
                if [[ "$current_session" != "$target_session" ]]; then
                    print_error "セッション '$target_session' が見つかりません"
                    echo ""
                    echo "利用可能なセッション一覧:"
                    echo -e "  ${YELLOW}./scripts/ignite cost -l${NC}"
                    exit 1
                fi
            else
                print_error "セッション情報が見つかりません"
                exit 1
            fi
        fi
    fi

    if [[ ! -f "$sessions_file" ]]; then
        print_error "セッション情報が見つかりません: $sessions_file"
        echo ""
        echo "IGNITEシステムを起動してください:"
        echo -e "  ${YELLOW}./scripts/ignite start${NC}"
        exit 1
    fi

    # セッション情報を読み取り
    if [[ -z "$started_at" ]]; then
        started_at=$(grep "^started_at:" "$sessions_file" | awk '{print $2}' | tr -d '"')
    fi
    local session_name=$(grep "^session_name:" "$sessions_file" | awk '{print $2}' | tr -d '"')

    # 経過時間を計算
    local elapsed=""
    if [[ -n "$started_at" ]]; then
        local start_epoch=$(date -d "$started_at" +%s 2>/dev/null || echo "0")
        local now_epoch=$(date +%s)
        local diff=$((now_epoch - start_epoch))
        local hours=$((diff / 3600))
        local minutes=$(((diff % 3600) / 60))
        elapsed="${hours}h ${minutes}m"
    fi

    # エージェント定義
    local -a agents=("leader" "strategist" "architect" "evaluator" "coordinator" "innovator")
    local -a agent_names=("伊羽ユイ" "義賀リオ" "祢音ナナ" "衣結ノア" "通瀬アイナ" "恵那ツムギ")

    # 各エージェントのトークン使用量を集計
    declare -A agent_input
    declare -A agent_output
    declare -A agent_cache_read
    declare -A agent_cache_creation
    declare -A agent_cost

    local total_input=0
    local total_output=0
    local total_cache_read=0
    local total_cache_creation=0
    local total_cost=0

    # Sub-Leaders と Leader の集計
    for i in "${!agents[@]}"; do
        local role="${agents[$i]}"

        # 特定エージェントのみ表示する場合
        if [[ -n "$target_agent" ]] && [[ "$target_agent" != "$role" ]] && [[ "$target_agent" != "ignitians" ]]; then
            continue
        fi

        local session_id=$(get_agent_session_id "$role")
        if [[ -n "$session_id" ]]; then
            local tokens=$(collect_session_tokens "$session_id")
            local input=$(echo "$tokens" | jq -r '.input')
            local output=$(echo "$tokens" | jq -r '.output')
            local cache_read=$(echo "$tokens" | jq -r '.cache_read')
            local cache_creation=$(echo "$tokens" | jq -r '.cache_creation')
            local cost=$(calculate_cost "$input" "$output" "$cache_read" "$cache_creation")

            agent_input[$role]=$input
            agent_output[$role]=$output
            agent_cache_read[$role]=$cache_read
            agent_cache_creation[$role]=$cache_creation
            agent_cost[$role]=$cost

            total_input=$((total_input + input))
            total_output=$((total_output + output))
            total_cache_read=$((total_cache_read + cache_read))
            total_cache_creation=$((total_cache_creation + cache_creation))
            total_cost=$(echo "$total_cost + $cost" | bc)
        fi
    done

    # IGNITIANs の集計
    local ignitian_input=0
    local ignitian_output=0
    local ignitian_cache_read=0
    local ignitian_cache_creation=0
    local ignitian_cost=0
    local ignitian_count=0
    declare -A ignitian_data

    # ignitians セクションを解析
    local in_ignitians=false
    local current_ignitian=""
    while IFS= read -r line; do
        if [[ "$line" =~ ^[[:space:]]*ignitians: ]]; then
            in_ignitians=true
            continue
        fi
        if [[ "$in_ignitians" == true ]]; then
            if [[ "$line" =~ ^[[:space:]]*ignitian_([0-9]+): ]]; then
                current_ignitian="ignitian_${BASH_REMATCH[1]}"
                ignitian_count=$((ignitian_count + 1))
            elif [[ "$line" =~ ^[[:space:]]*session_id:[[:space:]]*\"?([^\"]+)\"? ]] && [[ -n "$current_ignitian" ]]; then
                local session_id="${BASH_REMATCH[1]}"
                if [[ -n "$session_id" ]] && [[ "$session_id" != "null" ]]; then
                    local tokens=$(collect_session_tokens "$session_id")
                    local input=$(echo "$tokens" | jq -r '.input')
                    local output=$(echo "$tokens" | jq -r '.output')
                    local cache_read=$(echo "$tokens" | jq -r '.cache_read')
                    local cache_creation=$(echo "$tokens" | jq -r '.cache_creation')
                    local cost=$(calculate_cost "$input" "$output" "$cache_read" "$cache_creation")

                    ignitian_data[$current_ignitian]="$input:$output:$cache_read:$cache_creation:$cost"

                    ignitian_input=$((ignitian_input + input))
                    ignitian_output=$((ignitian_output + output))
                    ignitian_cache_read=$((ignitian_cache_read + cache_read))
                    ignitian_cache_creation=$((ignitian_cache_creation + cache_creation))
                    ignitian_cost=$(echo "$ignitian_cost + $cost" | bc)
                fi
                current_ignitian=""
            elif [[ "$line" =~ ^[a-z]+: ]]; then
                # インデントなしの新しいセクションが始まったら終了
                in_ignitians=false
            fi
        fi
    done < "$sessions_file"

    # IGNITIANs の合計を全体に追加
    total_input=$((total_input + ignitian_input))
    total_output=$((total_output + ignitian_output))
    total_cache_read=$((total_cache_read + ignitian_cache_read))
    total_cache_creation=$((total_cache_creation + ignitian_cache_creation))
    total_cost=$(echo "$total_cost + $ignitian_cost" | bc)

    # JSON出力モード
    if [[ "$json_output" == true ]]; then
        local json_agents="{"
        local first=true
        for i in "${!agents[@]}"; do
            local role="${agents[$i]}"
            if [[ -n "${agent_input[$role]:-}" ]]; then
                if [[ "$first" == false ]]; then json_agents+=","; fi
                first=false
                json_agents+="\"$role\":{\"input\":${agent_input[$role]},\"output\":${agent_output[$role]},\"cache_read\":${agent_cache_read[$role]},\"cache_creation\":${agent_cache_creation[$role]},\"cost\":${agent_cost[$role]}}"
            fi
        done
        json_agents+=",\"ignitians\":{\"count\":$ignitian_count,\"input\":$ignitian_input,\"output\":$ignitian_output,\"cache_read\":$ignitian_cache_read,\"cache_creation\":$ignitian_cache_creation,\"cost\":$ignitian_cost}"
        json_agents+="}"

        local jpy_cost=$(echo "$total_cost * $EXCHANGE_RATE" | bc)
        echo "{\"session\":\"$session_name\",\"started_at\":\"$started_at\",\"elapsed\":\"$elapsed\",\"agents\":$json_agents,\"total\":{\"input\":$total_input,\"output\":$total_output,\"cache_read\":$total_cache_read,\"cache_creation\":$total_cache_creation,\"cost\":$total_cost,\"cost_jpy\":$jpy_cost}}"
        return 0
    fi

    # テーブル表示
    print_header "IGNITE コスト概要"
    echo ""

    if [[ -n "$session_name" ]]; then
        echo -e "${BLUE}セッション:${NC} $session_name"
    fi
    if [[ -n "$started_at" ]]; then
        local started_display=$(echo "$started_at" | tr 'T' ' ' | cut -d'+' -f1)
        echo -e "${BLUE}セッション開始:${NC} $started_display"
    fi
    if [[ -n "$elapsed" ]]; then
        echo -e "${BLUE}経過時間:${NC} $elapsed"
    fi
    echo ""

    # テーブル列幅定義（表示幅）
    local col1_width=14  # エージェント名
    local col2_width=12  # 入力トークン
    local col3_width=12  # 出力トークン
    local col5_width=13  # キャッシュ（読込/作成）
    local col4_width=11  # 費用

    # テーブルヘッダー
    echo "┌────────────────┬──────────────┬──────────────┬───────────────┬─────────────┐"
    printf "│ %s │ %s │ %s │ %s │ %s │\n" \
        "$(pad_right "エージェント" $col1_width)" \
        "$(pad_left "入力トークン" $col2_width)" \
        "$(pad_left "出力トークン" $col3_width)" \
        "$(pad_left "Cache(R/W)" $col5_width)" \
        "$(pad_left "費用 (USD)" $col4_width)"
    echo "├────────────────┼──────────────┼──────────────┼───────────────┼─────────────┤"

    # Leader と Sub-Leaders
    for i in "${!agents[@]}"; do
        local role="${agents[$i]}"
        local name="${agent_names[$i]}"

        if [[ -n "$target_agent" ]] && [[ "$target_agent" != "$role" ]] && [[ "$target_agent" != "ignitians" ]]; then
            continue
        fi

        if [[ -n "${agent_input[$role]:-}" ]]; then
            local input_fmt=$(format_number "${agent_input[$role]}")
            local output_fmt=$(format_number "${agent_output[$role]}")
            local cache_r=$(echo "scale=1; ${agent_cache_read[$role]:-0} / 1000000" | bc)
            local cache_c=$(echo "scale=1; ${agent_cache_creation[$role]:-0} / 1000000" | bc)
            local cache_fmt="${cache_r}/${cache_c}M"
            local cost_fmt=$(printf "\$%8.2f" "${agent_cost[$role]}")
            printf "│ %s │ %s │ %s │ %s │ %s │\n" \
                "$(pad_right "$name" $col1_width)" \
                "$(pad_left "$input_fmt" $col2_width)" \
                "$(pad_left "$output_fmt" $col3_width)" \
                "$(pad_left "$cache_fmt" $col5_width)" \
                "$(pad_left "$cost_fmt" $col4_width)"
        fi
    done

    # IGNITIANs
    if [[ -z "$target_agent" ]] || [[ "$target_agent" == "ignitians" ]]; then
        if [[ $ignitian_count -gt 0 ]]; then
            echo "├────────────────┼──────────────┼──────────────┼───────────────┼─────────────┤"

            if [[ "$detailed" == true ]]; then
                # 詳細表示: 各IGNITIANを個別に表示
                for key in $(echo "${!ignitian_data[@]}" | tr ' ' '\n' | sort -V); do
                    local data="${ignitian_data[$key]}"
                    local input=$(echo "$data" | cut -d: -f1)
                    local output=$(echo "$data" | cut -d: -f2)
                    local cache_read=$(echo "$data" | cut -d: -f3)
                    local cache_create=$(echo "$data" | cut -d: -f4)
                    local cost=$(echo "$data" | cut -d: -f5)
                    local input_fmt=$(format_number "$input")
                    local output_fmt=$(format_number "$output")
                    local cache_r=$(echo "scale=1; ${cache_read:-0} / 1000000" | bc)
                    local cache_c=$(echo "scale=1; ${cache_create:-0} / 1000000" | bc)
                    local cache_fmt="${cache_r}/${cache_c}M"
                    local cost_fmt=$(printf "\$%8.2f" "$cost")
                    local display_name=$(echo "$key" | sed 's/ignitian_/IGNITIAN-/')
                    printf "│ %s │ %s │ %s │ %s │ %s │\n" \
                        "$(pad_right "$display_name" $col1_width)" \
                        "$(pad_left "$input_fmt" $col2_width)" \
                        "$(pad_left "$output_fmt" $col3_width)" \
                        "$(pad_left "$cache_fmt" $col5_width)" \
                        "$(pad_left "$cost_fmt" $col4_width)"
                done
            else
                # 集計表示
                local ignitian_input_fmt=$(format_number "$ignitian_input")
                local ignitian_output_fmt=$(format_number "$ignitian_output")
                local ign_cache_r=$(echo "scale=1; ${ignitian_cache_read:-0} / 1000000" | bc)
                local ign_cache_c=$(echo "scale=1; ${ignitian_cache_creation:-0} / 1000000" | bc)
                local ignitian_cache_fmt="${ign_cache_r}/${ign_cache_c}M"
                local ignitian_cost_fmt=$(printf "\$%8.2f" "$ignitian_cost")
                local ignitian_label="IGNITIANs ($ignitian_count)"
                printf "│ %s │ %s │ %s │ %s │ %s │\n" \
                    "$(pad_right "$ignitian_label" $col1_width)" \
                    "$(pad_left "$ignitian_input_fmt" $col2_width)" \
                    "$(pad_left "$ignitian_output_fmt" $col3_width)" \
                    "$(pad_left "$ignitian_cache_fmt" $col5_width)" \
                    "$(pad_left "$ignitian_cost_fmt" $col4_width)"
            fi
        fi
    fi

    # 合計
    if [[ -z "$target_agent" ]]; then
        echo "├────────────────┼──────────────┼──────────────┼───────────────┼─────────────┤"
        local total_input_fmt=$(format_number "$total_input")
        local total_output_fmt=$(format_number "$total_output")
        local total_cache_r=$(echo "scale=1; ${total_cache_read:-0} / 1000000" | bc)
        local total_cache_c=$(echo "scale=1; ${total_cache_creation:-0} / 1000000" | bc)
        local total_cache_fmt="${total_cache_r}/${total_cache_c}M"
        local total_cost_fmt=$(printf "\$%8.2f" "$total_cost")
        local jpy_cost=$(printf "%.0f" "$(echo "$total_cost * $EXCHANGE_RATE" | bc)")
        printf "│ %s │ %s │ %s │ %s │ %s │\n" \
            "$(pad_right "合計" $col1_width)" \
            "$(pad_left "$total_input_fmt" $col2_width)" \
            "$(pad_left "$total_output_fmt" $col3_width)" \
            "$(pad_left "$total_cache_fmt" $col5_width)" \
            "$(pad_left "$total_cost_fmt" $col4_width)"
    fi

    echo "└────────────────┴──────────────┴──────────────┴───────────────┴─────────────┘"

    echo ""
    echo -e "${BLUE}料金:${NC} Claude Opus 4.5 (\$${PRICE_INPUT}/1M入力, \$${PRICE_OUTPUT}/1M出力)"
    if [[ -z "$target_agent" ]]; then
        echo -e "${BLUE}日本円概算:${NC} ¥$(format_number "$jpy_cost") (税別, \$1=¥${EXCHANGE_RATE})"
    fi

    # 詳細表示の場合はキャッシュ情報も表示
    if [[ "$detailed" == true ]]; then
        echo ""
        echo -e "${BLUE}キャッシュ使用量:${NC}"
        echo "  キャッシュ読み込み: $(format_number "$total_cache_read") トークン"
        echo "  キャッシュ作成: $(format_number "$total_cache_creation") トークン"
    fi
}

# =============================================================================
# list コマンド - 実行中のセッション一覧
# =============================================================================
cmd_list() {
    print_header "実行中のIGNITEセッション"
    echo ""

    local sessions
    sessions=$(tmux list-sessions -F '#{session_name} (#{session_windows} windows, created #{session_created_string})' 2>/dev/null | grep "^ignite-" || true)

    if [[ -z "$sessions" ]]; then
        print_warning "実行中のIGNITEセッションはありません"
        echo ""
        echo -e "新しいセッションを起動: ${YELLOW}./scripts/ignite start${NC}"
    else
        echo "$sessions" | while read -r session; do
            echo -e "  ${GREEN}●${NC} $session"
        done
        echo ""
        echo -e "セッションに接続: ${YELLOW}./scripts/ignite attach -s <session-id>${NC}"
        echo -e "セッションを停止: ${YELLOW}./scripts/ignite stop -s <session-id>${NC}"
    fi
}

# =============================================================================
# help コマンド
# =============================================================================
cmd_help() {
    local command="${1:-}"

    case "$command" in
        start)
            echo "使用方法: ./scripts/ignite start [オプション]"
            echo ""
            echo "IGNITE システムを起動します"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>    セッションIDを指定（未指定時は自動生成）"
            echo "  -w, --workspace <dir> ワークスペースディレクトリを指定"
            echo "  -n, --no-attach       起動後に自動アタッチしない"
            echo "  -f, --force           既存セッションを強制終了して再起動"
            echo "  -a, --agents <mode>   エージェント起動モード"
            echo "                          full:   全エージェント（デフォルト）"
            echo "                          leader: Leaderのみ"
            echo "                          sub:    Leader + Sub-Leaders（IGNITIANsなし）"
            echo "  --workers <N>         IGNITIANs並列数（1-32）"
            echo "  --no-workers          IGNITIANsを起動しない"
            echo "  --with-watcher        GitHub Watcherも一緒に起動"
            echo "  --no-watcher          GitHub Watcherを起動しない（設定で有効でも）"
            echo "  -h, --help            このヘルプを表示"
            echo ""
            echo "ペインレイアウト (fullモード):"
            echo "  pane 0:    Leader (伊羽ユイ)"
            echo "  pane 1-5:  Sub-Leaders (義賀リオ, 祢音ナナ, 衣結ノア, 通瀬アイナ, 恵那ツムギ)"
            echo "  pane 6+:   IGNITIANs (デフォルト3並列)"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite start                        # 全エージェント起動（自動ID）"
            echo "  ./scripts/ignite start -s proj-a              # セッションID指定で起動"
            echo "  ./scripts/ignite start -w /tmp/ws1            # ワークスペース指定で起動"
            echo "  ./scripts/ignite start -s proj-a -w /tmp/ws1  # 両方指定"
            echo "  ./scripts/ignite start -a leader              # Leaderのみ起動"
            echo "  ./scripts/ignite start -a sub                 # Leader + Sub-Leadersのみ"
            echo "  ./scripts/ignite start --workers 4            # IGNITIANs 4並列で起動"
            echo "  ./scripts/ignite start --with-watcher         # GitHub Watcherも起動"
            ;;
        stop)
            echo "使用方法: ./scripts/ignite stop [オプション]"
            echo ""
            echo "IGNITE システムを停止します"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>  停止するセッションIDを指定"
            echo "  -y, --yes           確認をスキップ"
            echo "  -h, --help          このヘルプを表示"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite stop              # 実行中のセッションを停止"
            echo "  ./scripts/ignite stop -s proj-a    # 指定セッションを停止"
            echo "  ./scripts/ignite stop -y           # 確認なしで停止"
            ;;
        plan)
            echo "使用方法: ./scripts/ignite plan <目標> [オプション]"
            echo ""
            echo "タスクを投入します"
            echo ""
            echo "引数:"
            echo "  <目標>    実行したいタスクの目標"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>      対象セッションIDを指定"
            echo "  -w, --workspace <dir>   ワークスペースを指定"
            echo "  -c, --context <text>    コンテキストを追加"
            echo "  -h, --help              このヘルプを表示"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite plan \"READMEを作成する\""
            echo "  ./scripts/ignite plan \"認証機能を実装\" -c \"JWT認証、セッション管理\""
            echo "  ./scripts/ignite plan \"機能追加\" -s proj-a -w /tmp/ws-a"
            ;;
        status)
            echo "使用方法: ./scripts/ignite status [オプション]"
            echo ""
            echo "システムの状態を表示します"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>      対象セッションIDを指定"
            echo "  -w, --workspace <dir>   ワークスペースを指定"
            echo "  -h, --help              このヘルプを表示"
            echo ""
            echo "表示内容:"
            echo "  - tmuxセッション状態"
            echo "  - ダッシュボード"
            echo "  - キュー状態"
            echo "  - レポート数"
            echo "  - 最新ログ"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite status"
            echo "  ./scripts/ignite status -s proj-a"
            ;;
        attach)
            echo "使用方法: ./scripts/ignite attach [オプション]"
            echo ""
            echo "tmuxセッションに接続します"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>  接続するセッションIDを指定"
            echo "  -h, --help          このヘルプを表示"
            echo ""
            echo "tmux操作:"
            echo "  Ctrl+b d    セッションをデタッチ"
            echo "  Ctrl+b o    次のペインに移動"
            echo "  Ctrl+b [    スクロールモード"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite attach              # 実行中のセッションに接続"
            echo "  ./scripts/ignite attach -s proj-a    # 指定セッションに接続"
            ;;
        logs)
            echo "使用方法: ./scripts/ignite logs [オプション]"
            echo ""
            echo "ログを表示します"
            echo ""
            echo "オプション:"
            echo "  -w, --workspace <dir>  ワークスペースを指定"
            echo "  -f, --follow           リアルタイム監視 (tail -f)"
            echo "  -n, --lines <N>        表示行数 (デフォルト: 20)"
            echo "  -h, --help             このヘルプを表示"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite logs"
            echo "  ./scripts/ignite logs -f"
            echo "  ./scripts/ignite logs -w /tmp/ws-a -n 50"
            ;;
        clean)
            echo "使用方法: ./scripts/ignite clean [オプション]"
            echo ""
            echo "workspaceをクリアします"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>     対象セッションIDを指定"
            echo "  -w, --workspace <dir>  ワークスペースを指定"
            echo "  -y, --yes              確認をスキップ"
            echo "  -h, --help             このヘルプを表示"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite clean"
            echo "  ./scripts/ignite clean -w /tmp/ws-a -y"
            ;;
        activate)
            echo "使用方法: ./scripts/ignite activate [オプション]"
            echo ""
            echo "起動済みのエージェントをアクティベートします"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>  対象セッションIDを指定"
            echo "  -h, --help          このヘルプを表示"
            echo ""
            echo "説明:"
            echo "  起動時にシステムプロンプトが正しく実行されなかった場合に使用します。"
            echo "  各ペインに Enter を送信して、待機中のコマンドを実行させます。"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite activate"
            echo "  ./scripts/ignite activate -s proj-a"
            ;;
        notify)
            echo "使用方法: ./scripts/ignite notify <target> \"message\" [オプション]"
            echo ""
            echo "特定のエージェントにメッセージを送信します"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>     対象セッションIDを指定"
            echo "  -w, --workspace <dir>  ワークスペースを指定"
            echo "  -h, --help             このヘルプを表示"
            echo ""
            echo "ターゲット:"
            echo "  leader, strategist, architect, evaluator, coordinator, innovator, ignitians"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite notify strategist \"戦略を立案してください\""
            echo "  ./scripts/ignite notify ignitians \"タスク1を実行\" -s proj-a"
            ;;
        list)
            echo "使用方法: ./scripts/ignite list"
            echo ""
            echo "実行中のIGNITEセッション一覧を表示します"
            ;;
        work-on)
            echo "使用方法: ./scripts/ignite work-on <issue> [オプション]"
            echo ""
            echo "Issue番号を指定して実装を開始します"
            echo ""
            echo "引数:"
            echo "  <issue>    Issue番号またはURL"
            echo ""
            echo "オプション:"
            echo "  -r, --repo <repo>       リポジトリ（owner/repo形式）"
            echo "  -s, --session <id>      対象セッションIDを指定"
            echo "  -w, --workspace <dir>   ワークスペースを指定"
            echo "  -h, --help              このヘルプを表示"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite work-on 123 --repo owner/repo"
            echo "  ./scripts/ignite work-on https://github.com/owner/repo/issues/123"
            ;;
        watcher)
            echo "使用方法: ./scripts/ignite watcher <action>"
            echo ""
            echo "GitHub Watcherを管理します"
            echo ""
            echo "アクション:"
            echo "  start                       バックグラウンドで起動"
            echo "  stop                        停止"
            echo "  status                      状態確認"
            echo "  once                        単発実行"
            echo "  comment <issue> [options]   Issueにコメント投稿"
            echo "  ack <issue> [repo]          受付応答を投稿"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite watcher start"
            echo "  ./scripts/ignite watcher status"
            echo "  ./scripts/ignite watcher comment 123 --repo owner/repo --bot --body \"メッセージ\""
            echo "  ./scripts/ignite watcher ack 123 owner/repo"
            ;;
        cost)
            echo "使用方法: ./scripts/ignite cost [オプション]"
            echo ""
            echo "トークン消費量と概算費用を表示します"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>     対象セッションIDを指定"
            echo "  -w, --workspace <dir>  ワークスペースを指定"
            echo "  -a, --agent <role>     特定エージェントのみ表示"
            echo "  -d, --detailed         詳細表示（IGNITIANsの個別表示）"
            echo "  -j, --json             JSON形式で出力"
            echo "  -l, --list             コスト履歴一覧を表示"
            echo "  -h, --help             このヘルプを表示"
            echo ""
            echo "エージェント:"
            echo "  leader, strategist, architect, evaluator, coordinator, innovator, ignitians"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite cost                    # 現在のセッションのコスト"
            echo "  ./scripts/ignite cost -l                 # コスト履歴一覧"
            echo "  ./scripts/ignite cost -s proj-a          # 特定セッションのコスト"
            echo "  ./scripts/ignite cost -a leader          # Leaderのみ表示"
            echo "  ./scripts/ignite cost -d                 # 詳細表示"
            echo "  ./scripts/ignite cost -j                 # JSON出力"
            ;;
        "")
            echo -e "${BOLD}IGNITE${NC} - Intelligent Generative Networked Interaction-driven Task Engine"
            echo ""
            echo "使用方法: ./scripts/ignite <command> [options] [arguments]"
            echo ""
            echo "コマンド:"
            echo "  start     システムを起動"
            echo "  stop      システムを停止"
            echo "  list      実行中のセッション一覧"
            echo "  plan      タスクを投入"
            echo "  work-on   Issue番号を指定して実装開始"
            echo "  watcher   GitHub Watcherを管理"
            echo "  status    状態を確認"
            echo "  cost      トークン消費量・費用を表示"
            echo "  attach    tmuxセッションに接続"
            echo "  activate  エージェントをアクティベート"
            echo "  notify    エージェントに通知"
            echo "  logs      ログを表示"
            echo "  clean     workspaceをクリア"
            echo "  help      ヘルプを表示"
            echo ""
            echo "グローバルオプション:"
            echo "  -s, --session <id>    セッションIDを指定"
            echo "  -w, --workspace <dir> ワークスペースを指定"
            echo "  -h, --help            ヘルプを表示"
            echo "  -v, --version         バージョンを表示"
            echo ""
            echo "複数プロジェクト並行実行:"
            echo "  # プロジェクトAを起動"
            echo "  ./scripts/ignite start -s proj-a -w /tmp/workspace-a"
            echo ""
            echo "  # プロジェクトBを起動（別セッション）"
            echo "  ./scripts/ignite start -s proj-b -w /tmp/workspace-b"
            echo ""
            echo "  # セッション一覧確認"
            echo "  ./scripts/ignite list"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite start"
            echo "  ./scripts/ignite plan \"READMEを作成する\""
            echo "  ./scripts/ignite status"
            echo "  ./scripts/ignite logs -f"
            echo ""
            echo "詳細なヘルプ:"
            echo "  ./scripts/ignite help <command>"
            ;;
        *)
            print_error "Unknown command: $command"
            cmd_help
            exit 1
            ;;
    esac
}

# =============================================================================
# work-on コマンド - Issue番号を指定して実装開始
# =============================================================================
cmd_work_on() {
    local issue_input=""
    local repo=""

    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -r|--repo)
                repo="$2"
                shift 2
                ;;
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -w|--workspace)
                WORKSPACE_DIR="$2"
                if [[ ! "$WORKSPACE_DIR" = /* ]]; then
                    WORKSPACE_DIR="$(pwd)/$WORKSPACE_DIR"
                fi
                shift 2
                ;;
            -h|--help) cmd_help work-on; exit 0 ;;
            -*)
                print_error "Unknown option: $1"
                cmd_help work-on
                exit 1
                ;;
            *)
                if [[ -z "$issue_input" ]]; then
                    issue_input="$1"
                fi
                shift
                ;;
        esac
    done

    # セッション名とワークスペースを設定
    setup_session_name
    setup_workspace

    # Issue入力チェック
    if [[ -z "$issue_input" ]]; then
        print_error "Issue番号またはURLを指定してください"
        echo ""
        echo "使用方法:"
        echo "  ./scripts/ignite work-on 123 --repo owner/repo"
        echo "  ./scripts/ignite work-on https://github.com/owner/repo/issues/123"
        exit 1
    fi

    # URLかどうかチェック
    local issue_number=""
    if [[ "$issue_input" =~ ^https?://.*github\.com/([^/]+)/([^/]+)/issues/([0-9]+) ]]; then
        repo="${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
        issue_number="${BASH_REMATCH[3]}"
    else
        issue_number="$issue_input"
        if [[ -z "$repo" ]]; then
            # リポジトリを推測
            repo=$(gh repo view --json nameWithOwner -q '.nameWithOwner' 2>/dev/null || echo "")
            if [[ -z "$repo" ]]; then
                print_error "リポジトリを指定してください: --repo owner/repo"
                exit 1
            fi
        fi
    fi

    # セッションの存在確認
    if ! session_exists; then
        print_error "セッション '$SESSION_NAME' が見つかりません"
        echo ""
        print_info "実行中のセッション一覧:"
        list_sessions 2>/dev/null || true
        echo -e "${YELLOW}先に起動してください: ./scripts/ignite start${NC}"
        exit 1
    fi

    print_header "IGNITE Work-on Issue"
    echo ""
    echo -e "${BLUE}Issue:${NC} #$issue_number"
    echo -e "${BLUE}リポジトリ:${NC} $repo"
    echo ""

    # Issue情報を取得
    print_info "Issue情報を取得中..."
    local issue_info
    issue_info=$(gh api "/repos/${repo}/issues/${issue_number}" 2>/dev/null || echo "")

    if [[ -z "$issue_info" ]] || [[ "$issue_info" == "null" ]]; then
        print_error "Issue #${issue_number} が見つかりません"
        exit 1
    fi

    local issue_title=$(echo "$issue_info" | jq -r '.title')
    local issue_body=$(echo "$issue_info" | jq -r '.body // ""' | head -c 2000)
    local issue_url=$(echo "$issue_info" | jq -r '.html_url')

    print_success "Issue: $issue_title"
    echo ""

    # タイムスタンプとメッセージID生成
    local timestamp=$(date -Iseconds)
    local message_id=$(date +%s%N)

    # github_taskメッセージを作成
    local message_file="$WORKSPACE_DIR/queue/leader/github_task_${message_id}.yaml"

    cat > "$message_file" <<EOF
type: github_task
from: user
to: leader
timestamp: "${timestamp}"
priority: high
payload:
  trigger: "implement"
  repository: ${repo}
  issue_number: ${issue_number}
  issue_title: "${issue_title}"
  issue_body: |
$(echo "$issue_body" | sed 's/^/    /')
  requested_by: user
  trigger_comment: "work-onコマンドによる手動トリガー"
  branch_prefix: "ignite/"
  url: "${issue_url}"
status: pending
EOF

    print_success "タスクメッセージを作成しました: $message_file"

    # Leaderに通知
    sleep 0.5
    tmux send-keys -t "$SESSION_NAME:ignite.0" \
        "$WORKSPACE_DIR/queue/leader/ に新しいタスクがあります。Issue #${issue_number}「${issue_title}」の実装を開始してください。"
    sleep 0.3
    tmux send-keys -t "$SESSION_NAME:ignite.0" C-m

    echo ""
    print_success "Issue #${issue_number} の実装タスクを投入しました"
    echo ""
    echo "次のステップ:"
    echo -e "  1. 進捗確認: ${YELLOW}./scripts/ignite status${NC}"
    echo -e "  2. ログ確認: ${YELLOW}./scripts/ignite logs -f${NC}"
    echo -e "  3. tmux確認: ${YELLOW}./scripts/ignite attach${NC}"
}

# =============================================================================
# watcher コマンド - GitHub Watcher管理
# =============================================================================
cmd_watcher() {
    local action="${1:-}"
    shift 2>/dev/null || true

    case "$action" in
        start)
            print_info "GitHub Watcherを起動します..."
            "$IGNITE_SCRIPTS_DIR/utils/github_watcher.sh" &
            print_success "GitHub Watcherをバックグラウンドで起動しました"
            ;;
        stop)
            print_info "GitHub Watcherを停止します..."
            pkill -f "github_watcher.sh" 2>/dev/null || true
            print_success "GitHub Watcherを停止しました"
            ;;
        status)
            if pgrep -f "github_watcher.sh" > /dev/null; then
                print_success "GitHub Watcher: 実行中"
                pgrep -f "github_watcher.sh" | while read pid; do
                    echo "  PID: $pid"
                done
            else
                print_warning "GitHub Watcher: 停止中"
            fi
            ;;
        once)
            print_info "GitHub Watcherを単発実行します..."
            "$IGNITE_SCRIPTS_DIR/utils/github_watcher.sh" --once
            ;;
        comment)
            # Issueにコメント投稿
            "$IGNITE_SCRIPTS_DIR/utils/comment_on_issue.sh" "$@"
            ;;
        ack)
            # 受付応答を投稿
            local issue="${1:-}"
            local repo="${2:-}"
            if [[ -z "$issue" ]]; then
                print_error "Issue番号を指定してください"
                echo "使用方法: ./scripts/ignite watcher ack <issue_number> [repo]"
                exit 1
            fi
            if [[ -n "$repo" ]]; then
                "$IGNITE_SCRIPTS_DIR/utils/comment_on_issue.sh" "$issue" --repo "$repo" --bot --template acknowledge
            else
                "$IGNITE_SCRIPTS_DIR/utils/comment_on_issue.sh" "$issue" --bot --template acknowledge
            fi
            ;;
        *)
            echo "使用方法: ./scripts/ignite watcher <action>"
            echo ""
            echo "アクション:"
            echo "  start                       バックグラウンドで起動"
            echo "  stop                        停止"
            echo "  status                      状態確認"
            echo "  once                        単発実行"
            echo "  comment <issue> [options]   Issueにコメント投稿"
            echo "  ack <issue> [repo]          受付応答を投稿"
            echo ""
            echo "コメント例:"
            echo "  ./scripts/ignite watcher comment 123 --repo owner/repo --bot --body \"メッセージ\""
            echo "  ./scripts/ignite watcher ack 123 owner/repo"
            ;;
    esac
}

# =============================================================================
# メイン
# =============================================================================
main() {
    case "${1:-}" in
        start)    shift; cmd_start "$@" ;;
        stop)     shift; cmd_stop "$@" ;;
        list)     cmd_list ;;
        plan)     shift; cmd_plan "$@" ;;
        status)   shift; cmd_status "$@" ;;
        cost)     shift; cmd_cost "$@" ;;
        attach)   shift; cmd_attach "$@" ;;
        activate) shift; cmd_activate "$@" ;;
        notify)   shift; cmd_notify "$@" ;;
        logs)     shift; cmd_logs "$@" ;;
        clean)    shift; cmd_clean "$@" ;;
        work-on)  shift; cmd_work_on "$@" ;;
        watcher)  shift; cmd_watcher "$@" ;;
        help)     shift; cmd_help "$@" ;;
        -h|--help) cmd_help ;;
        -v|--version) echo "IGNITE v$VERSION" ;;
        "") cmd_help ;;
        *) print_error "Unknown command: $1"; echo ""; cmd_help; exit 1 ;;
    esac
}

main "$@"
