#!/bin/bash
# IGNITE - 統合コマンド
# Intelligent Generative Networked Interaction-driven Task Engine

set -e
set -u

VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# セッション名とワークスペース（後でコマンドラインで上書き可能）
SESSION_NAME=""
WORKSPACE_DIR=""

# Sub-Leaders 定義
SUB_LEADERS=("strategist" "architect" "evaluator" "coordinator" "innovator")
SUB_LEADER_NAMES=("義賀リオ" "祢音ナナ" "衣結ノア" "通瀬アイナ" "恵那ツムギ")

# デフォルト設定
DEFAULT_WORKER_COUNT=8

# カラー定義
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# =============================================================================
# セッションID・ワークスペース管理
# =============================================================================

# セッションIDの自動生成（4文字のハッシュ）
generate_session_id() {
    # プロジェクトパス + タイムスタンプから短いIDを生成
    echo "ignite-$(echo "${PROJECT_ROOT}-$(date +%s)" | md5sum | cut -c1-4)"
}

# デフォルトのワークスペースパス
get_default_workspace() {
    echo "$PROJECT_ROOT/workspace"
}

# セッションIDの設定（指定がなければ自動生成）
setup_session_name() {
    if [[ -z "$SESSION_NAME" ]]; then
        # 既存セッションを検索
        local existing_session
        existing_session=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | grep "^ignite-" | head -1 || true)

        if [[ -n "$existing_session" ]]; then
            SESSION_NAME="$existing_session"
        else
            SESSION_NAME=$(generate_session_id)
        fi
    fi
}

# ワークスペースの設定（指定がなければデフォルト）
setup_workspace() {
    if [[ -z "$WORKSPACE_DIR" ]]; then
        WORKSPACE_DIR=$(get_default_workspace)
    fi
}

# 実行中の全IGNITEセッションを一覧表示
list_sessions() {
    local sessions
    sessions=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | grep "^ignite-" || true)

    if [[ -z "$sessions" ]]; then
        print_warning "実行中のIGNITEセッションはありません"
        return 1
    fi

    echo "$sessions"
}

# 共通関数
print_info() { echo -e "${BLUE}$1${NC}"; }
print_success() { echo -e "${GREEN}✓ $1${NC}"; }
print_warning() { echo -e "${YELLOW}⚠ $1${NC}"; }
print_error() { echo -e "${RED}❌ $1${NC}"; }
print_header() { echo -e "${BOLD}${CYAN}=== $1 ===${NC}"; }

# セッションが存在するかチェック
session_exists() {
    tmux has-session -t "$SESSION_NAME" 2>/dev/null
}

# 設定ファイルからワーカー数を取得
get_worker_count() {
    local config_file="$PROJECT_ROOT/config/ignitians.yaml"
    if [[ -f "$config_file" ]]; then
        local count
        count=$(grep "default:" "$config_file" | head -1 | awk '{print $2}')
        if [[ -n "$count" ]] && [[ "$count" =~ ^[0-9]+$ ]]; then
            echo "$count"
            return
        fi
    fi
    echo "$DEFAULT_WORKER_COUNT"
}

# エージェント起動関数（最大3回リトライ）
start_agent() {
    local role="$1"      # strategist, architect, etc.
    local name="$2"      # 義賀リオ, 祢音ナナ, etc.
    local pane="$3"      # ペイン番号
    local max_retries=3
    local retry=0

    while [[ $retry -lt $max_retries ]]; do
        print_info "${name} を起動中... (試行 $((retry+1))/$max_retries)"

        # ペイン作成
        tmux split-window -t "$SESSION_NAME:ignite" -h
        tmux select-layout -t "$SESSION_NAME:ignite" tiled

        # Claude CLI 起動
        tmux send-keys -t "$SESSION_NAME:ignite.$pane" \
            "cd '$PROJECT_ROOT' && claude --model claude-opus-4-5-20251101 --dangerously-skip-permissions" Enter
        sleep 3

        # 権限確認通過
        tmux send-keys -t "$SESSION_NAME:ignite.$pane" Down
        sleep 0.5
        tmux send-keys -t "$SESSION_NAME:ignite.$pane" Enter
        sleep 8

        # 起動確認（ペインが生きているか）
        if tmux list-panes -t "$SESSION_NAME:ignite" 2>/dev/null | grep -q "$pane:"; then
            # システムプロンプト読み込み
            tmux send-keys -t "$SESSION_NAME:ignite.$pane" \
                "instructions/${role}.md を読んで、あなたは${name}として振る舞ってください。workspace/queue/${role}/ のメッセージを監視してください。"
            sleep 0.3
            tmux send-keys -t "$SESSION_NAME:ignite.$pane" C-m
            sleep 2  # プロンプト送信後の安定待機
            print_success "${name} 起動完了"
            return 0
        fi

        print_warning "${name} 起動失敗、リトライ中..."
        ((retry++))
        sleep 2
    done

    print_error "${name} 起動に失敗しました（${max_retries}回試行）"
    return 1
}

# IGNITIANS 起動関数
start_ignitian() {
    local id="$1"        # IGNITIAN番号 (1, 2, 3, ...)
    local pane="$2"      # ペイン番号
    local max_retries=3
    local retry=0

    while [[ $retry -lt $max_retries ]]; do
        print_info "IGNITIAN-${id} を起動中... (試行 $((retry+1))/$max_retries)"

        # ペイン作成
        tmux split-window -t "$SESSION_NAME:ignite" -h
        tmux select-layout -t "$SESSION_NAME:ignite" tiled

        # Claude CLI 起動
        tmux send-keys -t "$SESSION_NAME:ignite.$pane" \
            "cd '$PROJECT_ROOT' && claude --model claude-opus-4-5-20251101 --dangerously-skip-permissions" Enter
        sleep 3

        # 権限確認通過
        tmux send-keys -t "$SESSION_NAME:ignite.$pane" Down
        sleep 0.5
        tmux send-keys -t "$SESSION_NAME:ignite.$pane" Enter
        sleep 8

        # 起動確認
        if tmux list-panes -t "$SESSION_NAME:ignite" 2>/dev/null | grep -q "$pane:"; then
            # システムプロンプト読み込み
            tmux send-keys -t "$SESSION_NAME:ignite.$pane" \
                "instructions/ignitians.md を読んで、あなたはIGNITIAN-${id}として振る舞ってください。workspace/queue/ignitians/ignitian_${id}.yaml を監視してください。"
            sleep 0.3
            tmux send-keys -t "$SESSION_NAME:ignite.$pane" C-m
            sleep 2  # プロンプト送信後の安定待機
            print_success "IGNITIAN-${id} 起動完了"
            return 0
        fi

        print_warning "IGNITIAN-${id} 起動失敗、リトライ中..."
        ((retry++))
        sleep 2
    done

    print_error "IGNITIAN-${id} 起動に失敗しました（${max_retries}回試行）"
    return 1
}

# =============================================================================
# start コマンド
# =============================================================================
cmd_start() {
    local no_attach=false
    local force=false
    local agent_mode="full"    # full, leader, sub
    local worker_count=""
    local no_workers=false

    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -n|--no-attach) no_attach=true; shift ;;
            -f|--force) force=true; shift ;;
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -w|--workspace)
                WORKSPACE_DIR="$2"
                if [[ ! "$WORKSPACE_DIR" = /* ]]; then
                    WORKSPACE_DIR="$PROJECT_ROOT/$WORKSPACE_DIR"
                fi
                shift 2
                ;;
            -a|--agents)
                agent_mode="$2"
                if [[ ! "$agent_mode" =~ ^(full|leader|sub)$ ]]; then
                    print_error "無効なエージェントモード: $agent_mode (full/leader/sub)"
                    exit 1
                fi
                shift 2
                ;;
            --workers)
                worker_count="$2"
                if [[ ! "$worker_count" =~ ^[0-9]+$ ]] || [[ "$worker_count" -lt 1 ]] || [[ "$worker_count" -gt 32 ]]; then
                    print_error "ワーカー数は1-32の範囲で指定してください: $worker_count"
                    exit 1
                fi
                shift 2
                ;;
            --no-workers) no_workers=true; shift ;;
            -h|--help) cmd_help start; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help start; exit 1 ;;
        esac
    done

    # セッション名が未指定の場合は自動生成
    if [[ -z "$SESSION_NAME" ]]; then
        SESSION_NAME=$(generate_session_id)
    fi

    # ワークスペースが未指定の場合はデフォルト
    setup_workspace

    # ワーカー数の決定
    if [[ -z "$worker_count" ]]; then
        worker_count=$(get_worker_count)
    fi

    # --no-workers が指定された場合
    if [[ "$no_workers" == true ]]; then
        worker_count=0
    fi

    # agent_mode が leader の場合は Sub-Leaders も起動しない
    if [[ "$agent_mode" == "leader" ]]; then
        worker_count=0
    fi

    # エラートラップ
    trap 'print_error "エラーが発生しました (line $LINENO)"' ERR

    print_header "IGNITE システム起動"
    echo ""
    echo -e "${BLUE}セッションID:${NC} $SESSION_NAME"
    echo -e "${BLUE}ワークスペース:${NC} $WORKSPACE_DIR"
    echo -e "${BLUE}起動モード:${NC} $agent_mode"
    if [[ "$agent_mode" != "leader" ]]; then
        echo -e "${BLUE}Sub-Leaders:${NC} ${#SUB_LEADERS[@]}名"
    fi
    if [[ "$worker_count" -gt 0 ]]; then
        echo -e "${BLUE}IGNITIANs:${NC} ${worker_count}並列"
    fi
    echo ""

    cd "$PROJECT_ROOT"

    # 既存のセッションチェック
    if session_exists; then
        if [[ "$force" == true ]]; then
            print_warning "既存のセッションを強制終了します"
            tmux kill-session -t "$SESSION_NAME"
            print_success "既存セッションを終了しました"
        else
            print_warning "既存のignite-sessionが見つかりました"
            read -p "既存のセッションを終了して再起動しますか? (y/N): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                tmux kill-session -t "$SESSION_NAME"
                print_success "既存セッションを終了しました"
            else
                print_info "既存セッションにアタッチします"
                tmux attach -t "$SESSION_NAME"
                exit 0
            fi
        fi
    fi

    # workspaceの初期化
    print_info "workspaceを初期化中..."
    mkdir -p "$WORKSPACE_DIR/queue"/{leader,strategist,architect,evaluator,coordinator,innovator,ignitians}
    mkdir -p "$WORKSPACE_DIR/reports"
    mkdir -p "$WORKSPACE_DIR/context"
    mkdir -p "$WORKSPACE_DIR/logs"

    # 初期ダッシュボードの作成
    print_info "初期ダッシュボードを作成中..."
    cat > "$WORKSPACE_DIR/dashboard.md" <<EOF
# IGNITE Dashboard

更新日時: $(date '+%Y-%m-%d %H:%M:%S')

## システム状態
⏳ Leader (伊羽ユイ): 起動中...

## 現在のタスク
タスクなし - システム起動中

## 最新ログ
[$(date '+%H:%M:%S')] システム起動を開始しました
EOF

    print_success "workspace初期化完了"
    echo ""

    # tmuxセッション作成
    print_info "tmuxセッションを作成中..."
    tmux new-session -d -s "$SESSION_NAME" -n ignite
    sleep 0.5  # セッション作成を待機

    # Leader ペイン (pane 0)
    print_info "Leader (伊羽ユイ) を起動中..."
    tmux send-keys -t "$SESSION_NAME:ignite" \
        "cd '$PROJECT_ROOT' && claude --model claude-opus-4-5-20251101 --dangerously-skip-permissions" Enter

    # 起動待機（確認プロンプト表示を待つ）
    print_warning "Leaderの起動を待機中... (3秒)"
    sleep 3

    # 確認プロンプトを通過（下矢印で "Yes, I accept" を選択してEnter）
    print_info "権限確認を承諾中..."
    tmux send-keys -t "$SESSION_NAME:ignite" Down
    sleep 0.5
    tmux send-keys -t "$SESSION_NAME:ignite" Enter

    # Claude Codeの起動完了を待機
    print_warning "Claude Codeの起動を待機中... (8秒)"
    sleep 8

    # Leaderにシステムプロンプトを読み込ませる
    print_info "Leaderシステムプロンプトをロード中..."
    tmux send-keys -t "$SESSION_NAME:ignite" \
        "instructions/leader.md を読んで、あなたはLeader（伊羽ユイ）として振る舞ってください。その後、workspace/queue/leader/ 内のメッセージを確認してください。"
    sleep 0.3
    tmux send-keys -t "$SESSION_NAME:ignite" C-m

    # プロンプトロード完了を待機
    print_warning "Leaderの初期化を待機中... (10秒)"
    sleep 10

    # 初期メッセージの送信
    print_info "Leaderに初期化メッセージを送信中..."
    cat > "$WORKSPACE_DIR/queue/leader/system_init_$(date +%s).yaml" <<EOF
type: system_init
from: system
to: leader
timestamp: "$(date -Iseconds)"
priority: high
payload:
  message: "システムが起動しました。初期化を完了してください。"
  action: "initialize_dashboard"
status: pending
EOF

    echo ""
    print_success "IGNITE Leader が起動しました"

    # Sub-Leaders の起動 (agent_mode が leader 以外の場合)
    if [[ "$agent_mode" != "leader" ]]; then
        echo ""
        print_header "Sub-Leaders 起動"
        echo ""

        local pane_num=1
        for i in "${!SUB_LEADERS[@]}"; do
            local role="${SUB_LEADERS[$i]}"
            local name="${SUB_LEADER_NAMES[$i]}"

            if ! start_agent "$role" "$name" "$pane_num"; then
                print_warning "Sub-Leader ${name} の起動に失敗しましたが、続行します"
            fi

            ((pane_num++))
        done

        print_success "Sub-Leaders 起動完了 (${#SUB_LEADERS[@]}名)"
    fi

    # IGNITIANs の起動 (worker_count > 0 かつ agent_mode が full の場合)
    local actual_ignitian_count=0
    if [[ "$worker_count" -gt 0 ]] && [[ "$agent_mode" == "full" ]]; then
        echo ""
        print_header "IGNITIANs 起動"
        echo ""

        # Sub-Leaders の後のペイン番号から開始
        local start_pane=$((1 + ${#SUB_LEADERS[@]}))

        for ((i=1; i<=worker_count; i++)); do
            local pane_num=$((start_pane + i - 1))

            if ! start_ignitian "$i" "$pane_num"; then
                print_warning "IGNITIAN-${i} の起動に失敗しましたが、続行します"
            else
                actual_ignitian_count=$((actual_ignitian_count + 1))
            fi
        done

        print_success "IGNITIANs 起動完了 (${actual_ignitian_count}並列)"
    fi

    # システム設定ファイルを作成（IGNITIANs数などを記録）
    print_info "システム設定を保存中..."
    cat > "$WORKSPACE_DIR/system_config.yaml" <<EOF
# IGNITE システム設定（自動生成）
# このファイルはシステム起動時に自動的に更新されます

system:
  started_at: "$(date -Iseconds)"
  agent_mode: "${agent_mode}"
  session_name: "${SESSION_NAME}"
  workspace_dir: "${WORKSPACE_DIR}"

ignitians:
  count: ${actual_ignitian_count}
  ids: [$(seq -s ', ' 1 ${actual_ignitian_count} 2>/dev/null || echo "")]
EOF

    echo ""
    print_header "起動完了"
    echo ""
    echo "次のステップ:"
    echo -e "  1. tmuxセッションに接続: ${YELLOW}./scripts/ignite attach${NC}"
    echo -e "  2. ダッシュボード確認: ${YELLOW}./scripts/ignite status${NC}"
    echo -e "  3. タスク投入: ${YELLOW}./scripts/ignite plan \"目標\"${NC}"
    echo ""
    echo "tmuxセッション操作:"
    echo -e "  - デタッチ: ${YELLOW}Ctrl+b d${NC}"
    echo -e "  - セッション終了: ${YELLOW}./scripts/ignite stop${NC}"
    echo ""

    # 自動アタッチ
    if [[ "$no_attach" == false ]]; then
        read -p "tmuxセッションにアタッチしますか? (Y/n): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            tmux attach -t "$SESSION_NAME"
        fi
    fi
}

# =============================================================================
# activate コマンド - 各エージェントにコマンドを再送信
# =============================================================================
cmd_activate() {
    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -h|--help) cmd_help activate; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help activate; exit 1 ;;
        esac
    done

    # セッション名を設定
    setup_session_name

    if ! session_exists; then
        print_error "セッション '$SESSION_NAME' が見つかりません"
        echo ""
        print_info "実行中のセッション一覧:"
        list_sessions 2>/dev/null || true
        exit 1
    fi

    print_header "エージェントをアクティベート中"
    echo ""
    echo -e "${BLUE}セッション:${NC} $SESSION_NAME"
    echo ""

    # ペイン数を確認
    local pane_count
    pane_count=$(tmux list-panes -t "$SESSION_NAME" 2>/dev/null | wc -l)

    print_info "検出されたペイン数: $pane_count"

    # 各paneに対してEnterを送信して、入力待ちのコマンドを実行
    for ((i=1; i<pane_count; i++)); do
        print_info "pane $i をアクティベート中..."
        tmux send-keys -t "$SESSION_NAME:ignite.$i" Enter
        sleep 1
    done

    print_success "全エージェントにアクティベーション信号を送信しました"
    echo ""
    echo "各エージェントがシステムプロンプトを読み込んでいます。"
    echo -e "状態確認: ${YELLOW}./scripts/ignite status -s $SESSION_NAME${NC}"
}

# =============================================================================
# notify コマンド - 特定のエージェントにメッセージを送信
# =============================================================================
cmd_notify() {
    local target=""
    local message=""

    # 引数解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -w|--workspace)
                WORKSPACE_DIR="$2"
                if [[ ! "$WORKSPACE_DIR" = /* ]]; then
                    WORKSPACE_DIR="$PROJECT_ROOT/$WORKSPACE_DIR"
                fi
                shift 2
                ;;
            -h|--help) cmd_help notify; exit 0 ;;
            *)
                if [[ -z "$target" ]]; then
                    target="$1"
                elif [[ -z "$message" ]]; then
                    message="$1"
                fi
                shift
                ;;
        esac
    done

    # セッション名とワークスペースを設定
    setup_session_name
    setup_workspace

    if [[ -z "$target" ]] || [[ -z "$message" ]]; then
        print_error "ターゲットとメッセージを指定してください"
        echo "使用方法: ./scripts/ignite notify <target> \"message\""
        echo "ターゲット: leader, strategist, architect, evaluator, coordinator, innovator, ignitians"
        exit 1
    fi

    if ! session_exists; then
        print_error "セッション '$SESSION_NAME' が見つかりません"
        echo ""
        print_info "実行中のセッション一覧:"
        list_sessions 2>/dev/null || true
        exit 1
    fi

    cd "$PROJECT_ROOT"

    # メッセージファイル作成
    local timestamp=$(date -Iseconds)
    local message_id=$(date +%s%N)
    local message_file="$WORKSPACE_DIR/queue/${target}/notify_${message_id}.yaml"

    mkdir -p "$WORKSPACE_DIR/queue/${target}"

    cat > "$message_file" <<EOF
type: notification
from: user
to: ${target}
timestamp: "${timestamp}"
priority: normal
payload:
  message: "${message}"
status: pending
EOF

    print_success "メッセージを送信しました: $message_file"

    # ペイン番号を特定して通知
    local pane_num=0
    case "$target" in
        leader) pane_num=0 ;;
        strategist) pane_num=1 ;;
        architect) pane_num=2 ;;
        evaluator) pane_num=3 ;;
        coordinator) pane_num=4 ;;
        innovator) pane_num=5 ;;
        ignitians) pane_num=6 ;;  # 最初のIGNITIANに送信
    esac

    tmux send-keys -t "$SESSION_NAME:ignite.$pane_num" \
        "$WORKSPACE_DIR/queue/${target}/ に新しいメッセージがあります。確認してください。" Enter

    print_success "pane $pane_num に通知を送信しました"
}

# =============================================================================
# stop コマンド
# =============================================================================
cmd_stop() {
    local skip_confirm=false

    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -y|--yes) skip_confirm=true; shift ;;
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -h|--help) cmd_help stop; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help stop; exit 1 ;;
        esac
    done

    # セッション名を設定
    setup_session_name

    print_header "IGNITE システム停止"
    echo ""
    echo -e "${BLUE}対象セッション:${NC} $SESSION_NAME"
    echo ""

    # セッションの存在確認
    if ! session_exists; then
        print_error "セッション '$SESSION_NAME' が見つかりません"
        echo ""
        print_info "実行中のセッション一覧:"
        list_sessions 2>/dev/null || true
        exit 1
    fi

    # 確認
    if [[ "$skip_confirm" == false ]]; then
        read -p "IGNITE システムを停止しますか? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_warning "キャンセルしました"
            exit 0
        fi
    fi

    # セッション終了
    print_warning "tmuxセッションを終了中..."
    tmux kill-session -t "$SESSION_NAME"

    print_success "IGNITE システムを停止しました"
}

# =============================================================================
# plan コマンド
# =============================================================================
cmd_plan() {
    local goal=""
    local context=""

    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -c|--context) context="$2"; shift 2 ;;
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -w|--workspace)
                WORKSPACE_DIR="$2"
                if [[ ! "$WORKSPACE_DIR" = /* ]]; then
                    WORKSPACE_DIR="$PROJECT_ROOT/$WORKSPACE_DIR"
                fi
                shift 2
                ;;
            -h|--help) cmd_help plan; exit 0 ;;
            -*) print_error "Unknown option: $1"; cmd_help plan; exit 1 ;;
            *)
                if [[ -z "$goal" ]]; then
                    goal="$1"
                    shift
                else
                    print_error "引数が多すぎます"
                    cmd_help plan
                    exit 1
                fi
                ;;
        esac
    done

    # セッション名とワークスペースを設定
    setup_session_name
    setup_workspace

    # 引数チェック
    if [[ -z "$goal" ]]; then
        print_error "目標を指定してください"
        echo ""
        echo "使用方法:"
        echo "  ./scripts/ignite plan \"目標の内容\""
        echo "  ./scripts/ignite plan \"目標\" -c \"コンテキスト\""
        echo ""
        echo "例:"
        echo "  ./scripts/ignite plan \"READMEファイルを作成する\""
        echo "  ./scripts/ignite plan \"認証機能を実装\" -c \"JWT認証、セッション管理\""
        exit 1
    fi

    cd "$PROJECT_ROOT"

    # セッションの存在確認
    if ! session_exists; then
        print_error "セッション '$SESSION_NAME' が見つかりません"
        echo ""
        print_info "実行中のセッション一覧:"
        list_sessions 2>/dev/null || true
        echo -e "${YELLOW}先に起動してください: ./scripts/ignite start${NC}"
        exit 1
    fi

    print_header "IGNITE タスク投入"
    echo ""
    echo -e "${BLUE}目標:${NC} $goal"
    if [[ -n "$context" ]]; then
        echo -e "${BLUE}コンテキスト:${NC} $context"
    fi
    echo ""

    # タイムスタンプとメッセージID生成
    local timestamp=$(date -Iseconds)
    local message_id=$(date +%s)

    # Leaderへメッセージ送信
    local message_file="$WORKSPACE_DIR/queue/leader/user_goal_${message_id}.yaml"

    if [[ -n "$context" ]]; then
        cat > "$message_file" <<EOF
type: user_goal
from: user
to: leader
timestamp: "${timestamp}"
priority: high
payload:
  goal: "${goal}"
  context: "${context}"
status: pending
EOF
    else
        cat > "$message_file" <<EOF
type: user_goal
from: user
to: leader
timestamp: "${timestamp}"
priority: high
payload:
  goal: "${goal}"
status: pending
EOF
    fi

    print_success "メッセージを作成しました: $message_file"

    # Leaderに通知（自然言語プロンプトで送信）- pane 0 を明示的に指定
    sleep 0.5
    tmux send-keys -t "$SESSION_NAME:ignite.0" \
        "$WORKSPACE_DIR/queue/leader/ に新しいメッセージがあります。${message_file} を確認して処理してください。目標: ${goal}"
    sleep 0.3
    tmux send-keys -t "$SESSION_NAME:ignite.0" C-m

    echo ""
    print_success "タスク '${goal}' を投入しました"
    echo ""
    echo "次のステップ:"
    echo -e "  1. ダッシュボード確認: ${YELLOW}./scripts/ignite status${NC}"
    echo -e "  2. ログ確認: ${YELLOW}./scripts/ignite logs${NC}"
    echo -e "  3. tmuxセッション表示: ${YELLOW}./scripts/ignite attach${NC}"
}

# =============================================================================
# status コマンド
# =============================================================================
cmd_status() {
    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -w|--workspace)
                WORKSPACE_DIR="$2"
                if [[ ! "$WORKSPACE_DIR" = /* ]]; then
                    WORKSPACE_DIR="$PROJECT_ROOT/$WORKSPACE_DIR"
                fi
                shift 2
                ;;
            -h|--help) cmd_help status; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help status; exit 1 ;;
        esac
    done

    # セッション名とワークスペースを設定
    setup_session_name
    setup_workspace

    cd "$PROJECT_ROOT"

    print_header "IGNITE システム状態"
    echo ""
    echo -e "${BLUE}セッション:${NC} $SESSION_NAME"
    echo -e "${BLUE}ワークスペース:${NC} $WORKSPACE_DIR"
    echo ""

    # tmuxセッション確認
    if session_exists; then
        print_success "tmuxセッション: 実行中"

        # ペイン数確認
        local pane_count
        pane_count=$(tmux list-panes -t "$SESSION_NAME" 2>/dev/null | wc -l)
        echo -e "${BLUE}  ペイン数: ${pane_count}${NC}"

        # エージェント構成の推定
        echo ""
        print_header "エージェント状態"
        echo ""
        echo -e "  ${GREEN}✓${NC} pane 0: Leader (伊羽ユイ)"

        if [[ "$pane_count" -gt 1 ]]; then
            local sub_count=$((pane_count > 6 ? 5 : pane_count - 1))
            for i in $(seq 1 $sub_count); do
                local idx=$((i - 1))
                if [[ $idx -lt ${#SUB_LEADERS[@]} ]]; then
                    echo -e "  ${GREEN}✓${NC} pane ${i}: ${SUB_LEADER_NAMES[$idx]} (${SUB_LEADERS[$idx]})"
                fi
            done
        fi

        if [[ "$pane_count" -gt 6 ]]; then
            local ignitian_count=$((pane_count - 6))
            for i in $(seq 1 $ignitian_count); do
                local pane_num=$((5 + i))
                echo -e "  ${GREEN}✓${NC} pane ${pane_num}: IGNITIAN-${i}"
            done
        fi
    else
        print_error "tmuxセッション: 停止"
        exit 1
    fi

    echo ""

    # ダッシュボード表示
    if [[ -f "$WORKSPACE_DIR/dashboard.md" ]]; then
        print_header "ダッシュボード"
        echo ""
        cat "$WORKSPACE_DIR/dashboard.md"
        echo ""
    else
        print_warning "ダッシュボードが見つかりません"
    fi

    # キュー状態
    print_header "キュー状態"
    echo ""

    for queue_dir in "$WORKSPACE_DIR/queue"/*; do
        if [[ -d "$queue_dir" ]]; then
            local queue_name=$(basename "$queue_dir")
            local message_count=$(find "$queue_dir" -name "*.yaml" -type f 2>/dev/null | wc -l)

            if [[ "$message_count" -gt 0 ]]; then
                echo -e "${YELLOW}  $queue_name: $message_count メッセージ${NC}"
            else
                echo -e "${GREEN}  $queue_name: 0 メッセージ${NC}"
            fi
        fi
    done

    echo ""

    # レポート状態
    if [[ -d "$WORKSPACE_DIR/reports" ]]; then
        local report_count=$(find "$WORKSPACE_DIR/reports" -name "*.yaml" -type f 2>/dev/null | wc -l)
        print_header "レポート"
        echo "  完了レポート: ${report_count} 件"
        echo ""
    fi

    # 最新ログ
    print_header "最新ログ (直近5件)"
    echo ""

    if [[ -d "$WORKSPACE_DIR/logs" ]] && [[ "$(ls -A "$WORKSPACE_DIR/logs" 2>/dev/null)" ]]; then
        for log_file in "$WORKSPACE_DIR/logs"/*.log; do
            if [[ -f "$log_file" ]]; then
                echo -e "${BLUE}$(basename "$log_file"):${NC}"
                tail -n 5 "$log_file" 2>/dev/null | sed 's/^/  /'
                echo ""
            fi
        done
    else
        print_warning "ログファイルなし"
        echo ""
    fi

    print_header "コマンド"
    echo -e "  ダッシュボード監視: ${YELLOW}watch -n 5 cat $WORKSPACE_DIR/dashboard.md${NC}"
    echo -e "  tmuxアタッチ: ${YELLOW}./scripts/ignite attach -s $SESSION_NAME${NC}"
    echo -e "  システム停止: ${YELLOW}./scripts/ignite stop -s $SESSION_NAME${NC}"
}

# =============================================================================
# attach コマンド
# =============================================================================
cmd_attach() {
    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -h|--help) cmd_help attach; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help attach; exit 1 ;;
        esac
    done

    # セッション名を設定
    setup_session_name

    if ! session_exists; then
        print_error "セッション '$SESSION_NAME' が見つかりません"
        echo ""
        print_info "実行中のセッション一覧:"
        list_sessions 2>/dev/null || true
        echo -e "${YELLOW}先に起動してください: ./scripts/ignite start${NC}"
        exit 1
    fi

    tmux attach -t "$SESSION_NAME"
}

# =============================================================================
# logs コマンド
# =============================================================================
cmd_logs() {
    local follow=false
    local lines=20

    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--follow) follow=true; shift ;;
            -n|--lines) lines="$2"; shift 2 ;;
            -w|--workspace)
                WORKSPACE_DIR="$2"
                if [[ ! "$WORKSPACE_DIR" = /* ]]; then
                    WORKSPACE_DIR="$PROJECT_ROOT/$WORKSPACE_DIR"
                fi
                shift 2
                ;;
            -h|--help) cmd_help logs; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help logs; exit 1 ;;
        esac
    done

    # ワークスペースを設定
    setup_workspace

    cd "$PROJECT_ROOT"

    if [[ ! -d "$WORKSPACE_DIR/logs" ]] || [[ -z "$(ls -A "$WORKSPACE_DIR/logs" 2>/dev/null)" ]]; then
        print_warning "ログファイルが見つかりません"
        exit 0
    fi

    if [[ "$follow" == true ]]; then
        print_info "ログをリアルタイム監視中... (Ctrl+C で終了)"
        tail -f "$WORKSPACE_DIR/logs"/*.log 2>/dev/null
    else
        print_header "ログ (直近${lines}行)"
        echo ""
        for log_file in "$WORKSPACE_DIR/logs"/*.log; do
            if [[ -f "$log_file" ]]; then
                echo -e "${BLUE}=== $(basename "$log_file") ===${NC}"
                tail -n "$lines" "$log_file" 2>/dev/null
                echo ""
            fi
        done
    fi
}

# =============================================================================
# clean コマンド
# =============================================================================
cmd_clean() {
    local skip_confirm=false

    # オプション解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -y|--yes) skip_confirm=true; shift ;;
            -w|--workspace)
                WORKSPACE_DIR="$2"
                if [[ ! "$WORKSPACE_DIR" = /* ]]; then
                    WORKSPACE_DIR="$PROJECT_ROOT/$WORKSPACE_DIR"
                fi
                shift 2
                ;;
            -s|--session)
                SESSION_NAME="$2"
                if [[ ! "$SESSION_NAME" =~ ^ignite- ]]; then
                    SESSION_NAME="ignite-$SESSION_NAME"
                fi
                shift 2
                ;;
            -h|--help) cmd_help clean; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help clean; exit 1 ;;
        esac
    done

    # セッション名とワークスペースを設定
    setup_session_name
    setup_workspace

    cd "$PROJECT_ROOT"

    print_header "IGNITE workspaceクリア"
    echo ""
    echo -e "${BLUE}ワークスペース:${NC} $WORKSPACE_DIR"
    echo ""

    # セッションが実行中の場合は警告
    if session_exists; then
        print_warning "セッション '$SESSION_NAME' が実行中です"
        echo "先にシステムを停止することをお勧めします: ./scripts/ignite stop -s $SESSION_NAME"
        echo ""
    fi

    # 確認
    if [[ "$skip_confirm" == false ]]; then
        echo "以下のディレクトリがクリアされます:"
        echo "  - $WORKSPACE_DIR/queue/*"
        echo "  - $WORKSPACE_DIR/reports/*"
        echo "  - $WORKSPACE_DIR/logs/*"
        echo "  - $WORKSPACE_DIR/context/*"
        echo "  - $WORKSPACE_DIR/state/*"
        echo "  - $WORKSPACE_DIR/archive/*"
        echo "  - $WORKSPACE_DIR/dashboard.md"
        echo "  - $WORKSPACE_DIR/system_config.yaml"
        echo "  - $WORKSPACE_DIR/coordinator_state.yaml"
        echo ""
        read -p "続行しますか? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_warning "キャンセルしました"
            exit 0
        fi
    fi

    # クリーンアップ実行
    print_info "workspaceをクリア中..."

    rm -rf "$WORKSPACE_DIR/queue"/*/
    mkdir -p "$WORKSPACE_DIR/queue"/{leader,strategist,architect,evaluator,coordinator,innovator,ignitians}

    rm -rf "$WORKSPACE_DIR/reports"/*
    rm -rf "$WORKSPACE_DIR/logs"/*
    rm -rf "$WORKSPACE_DIR/context"/*
    rm -f "$WORKSPACE_DIR/dashboard.md"
    rm -f "$WORKSPACE_DIR/system_config.yaml"
    rm -f "$WORKSPACE_DIR/coordinator_state.yaml"
    rm -rf "$WORKSPACE_DIR/state"/*
    rm -rf "$WORKSPACE_DIR/archive"/*
    mkdir -p "$WORKSPACE_DIR/archive"/{leader,strategist,coordinator}

    print_success "workspaceをクリアしました"
}

# =============================================================================
# list コマンド - 実行中のセッション一覧
# =============================================================================
cmd_list() {
    print_header "実行中のIGNITEセッション"
    echo ""

    local sessions
    sessions=$(tmux list-sessions -F '#{session_name} (#{session_windows} windows, created #{session_created_string})' 2>/dev/null | grep "^ignite-" || true)

    if [[ -z "$sessions" ]]; then
        print_warning "実行中のIGNITEセッションはありません"
        echo ""
        echo -e "新しいセッションを起動: ${YELLOW}./scripts/ignite start${NC}"
    else
        echo "$sessions" | while read -r session; do
            echo -e "  ${GREEN}●${NC} $session"
        done
        echo ""
        echo -e "セッションに接続: ${YELLOW}./scripts/ignite attach -s <session-id>${NC}"
        echo -e "セッションを停止: ${YELLOW}./scripts/ignite stop -s <session-id>${NC}"
    fi
}

# =============================================================================
# help コマンド
# =============================================================================
cmd_help() {
    local command="${1:-}"

    case "$command" in
        start)
            echo "使用方法: ./scripts/ignite start [オプション]"
            echo ""
            echo "IGNITE システムを起動します"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>    セッションIDを指定（未指定時は自動生成）"
            echo "  -w, --workspace <dir> ワークスペースディレクトリを指定"
            echo "  -n, --no-attach       起動後に自動アタッチしない"
            echo "  -f, --force           既存セッションを強制終了して再起動"
            echo "  -a, --agents <mode>   エージェント起動モード"
            echo "                          full:   全エージェント（デフォルト）"
            echo "                          leader: Leaderのみ"
            echo "                          sub:    Leader + Sub-Leaders（IGNITIANsなし）"
            echo "  --workers <N>         IGNITIANs並列数（1-32）"
            echo "  --no-workers          IGNITIANsを起動しない"
            echo "  -h, --help            このヘルプを表示"
            echo ""
            echo "ペインレイアウト (fullモード):"
            echo "  pane 0:    Leader (伊羽ユイ)"
            echo "  pane 1-5:  Sub-Leaders (義賀リオ, 祢音ナナ, 衣結ノア, 通瀬アイナ, 恵那ツムギ)"
            echo "  pane 6+:   IGNITIANs (デフォルト8並列)"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite start                        # 全エージェント起動（自動ID）"
            echo "  ./scripts/ignite start -s proj-a              # セッションID指定で起動"
            echo "  ./scripts/ignite start -w /tmp/ws1            # ワークスペース指定で起動"
            echo "  ./scripts/ignite start -s proj-a -w /tmp/ws1  # 両方指定"
            echo "  ./scripts/ignite start -a leader              # Leaderのみ起動"
            echo "  ./scripts/ignite start -a sub                 # Leader + Sub-Leadersのみ"
            echo "  ./scripts/ignite start --workers 4            # IGNITIANs 4並列で起動"
            ;;
        stop)
            echo "使用方法: ./scripts/ignite stop [オプション]"
            echo ""
            echo "IGNITE システムを停止します"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>  停止するセッションIDを指定"
            echo "  -y, --yes           確認をスキップ"
            echo "  -h, --help          このヘルプを表示"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite stop              # 実行中のセッションを停止"
            echo "  ./scripts/ignite stop -s proj-a    # 指定セッションを停止"
            echo "  ./scripts/ignite stop -y           # 確認なしで停止"
            ;;
        plan)
            echo "使用方法: ./scripts/ignite plan <目標> [オプション]"
            echo ""
            echo "タスクを投入します"
            echo ""
            echo "引数:"
            echo "  <目標>    実行したいタスクの目標"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>      対象セッションIDを指定"
            echo "  -w, --workspace <dir>   ワークスペースを指定"
            echo "  -c, --context <text>    コンテキストを追加"
            echo "  -h, --help              このヘルプを表示"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite plan \"READMEを作成する\""
            echo "  ./scripts/ignite plan \"認証機能を実装\" -c \"JWT認証、セッション管理\""
            echo "  ./scripts/ignite plan \"機能追加\" -s proj-a -w /tmp/ws-a"
            ;;
        status)
            echo "使用方法: ./scripts/ignite status [オプション]"
            echo ""
            echo "システムの状態を表示します"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>      対象セッションIDを指定"
            echo "  -w, --workspace <dir>   ワークスペースを指定"
            echo "  -h, --help              このヘルプを表示"
            echo ""
            echo "表示内容:"
            echo "  - tmuxセッション状態"
            echo "  - ダッシュボード"
            echo "  - キュー状態"
            echo "  - レポート数"
            echo "  - 最新ログ"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite status"
            echo "  ./scripts/ignite status -s proj-a"
            ;;
        attach)
            echo "使用方法: ./scripts/ignite attach [オプション]"
            echo ""
            echo "tmuxセッションに接続します"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>  接続するセッションIDを指定"
            echo "  -h, --help          このヘルプを表示"
            echo ""
            echo "tmux操作:"
            echo "  Ctrl+b d    セッションをデタッチ"
            echo "  Ctrl+b o    次のペインに移動"
            echo "  Ctrl+b [    スクロールモード"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite attach              # 実行中のセッションに接続"
            echo "  ./scripts/ignite attach -s proj-a    # 指定セッションに接続"
            ;;
        logs)
            echo "使用方法: ./scripts/ignite logs [オプション]"
            echo ""
            echo "ログを表示します"
            echo ""
            echo "オプション:"
            echo "  -w, --workspace <dir>  ワークスペースを指定"
            echo "  -f, --follow           リアルタイム監視 (tail -f)"
            echo "  -n, --lines <N>        表示行数 (デフォルト: 20)"
            echo "  -h, --help             このヘルプを表示"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite logs"
            echo "  ./scripts/ignite logs -f"
            echo "  ./scripts/ignite logs -w /tmp/ws-a -n 50"
            ;;
        clean)
            echo "使用方法: ./scripts/ignite clean [オプション]"
            echo ""
            echo "workspaceをクリアします"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>     対象セッションIDを指定"
            echo "  -w, --workspace <dir>  ワークスペースを指定"
            echo "  -y, --yes              確認をスキップ"
            echo "  -h, --help             このヘルプを表示"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite clean"
            echo "  ./scripts/ignite clean -w /tmp/ws-a -y"
            ;;
        activate)
            echo "使用方法: ./scripts/ignite activate [オプション]"
            echo ""
            echo "起動済みのエージェントをアクティベートします"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>  対象セッションIDを指定"
            echo "  -h, --help          このヘルプを表示"
            echo ""
            echo "説明:"
            echo "  起動時にシステムプロンプトが正しく実行されなかった場合に使用します。"
            echo "  各ペインに Enter を送信して、待機中のコマンドを実行させます。"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite activate"
            echo "  ./scripts/ignite activate -s proj-a"
            ;;
        notify)
            echo "使用方法: ./scripts/ignite notify <target> \"message\" [オプション]"
            echo ""
            echo "特定のエージェントにメッセージを送信します"
            echo ""
            echo "オプション:"
            echo "  -s, --session <id>     対象セッションIDを指定"
            echo "  -w, --workspace <dir>  ワークスペースを指定"
            echo "  -h, --help             このヘルプを表示"
            echo ""
            echo "ターゲット:"
            echo "  leader, strategist, architect, evaluator, coordinator, innovator, ignitians"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite notify strategist \"戦略を立案してください\""
            echo "  ./scripts/ignite notify ignitians \"タスク1を実行\" -s proj-a"
            ;;
        list)
            echo "使用方法: ./scripts/ignite list"
            echo ""
            echo "実行中のIGNITEセッション一覧を表示します"
            ;;
        "")
            echo -e "${BOLD}IGNITE${NC} - Intelligent Generative Networked Interaction-driven Task Engine"
            echo ""
            echo "使用方法: ./scripts/ignite <command> [options] [arguments]"
            echo ""
            echo "コマンド:"
            echo "  start     システムを起動"
            echo "  stop      システムを停止"
            echo "  list      実行中のセッション一覧"
            echo "  plan      タスクを投入"
            echo "  status    状態を確認"
            echo "  attach    tmuxセッションに接続"
            echo "  activate  エージェントをアクティベート"
            echo "  notify    エージェントに通知"
            echo "  logs      ログを表示"
            echo "  clean     workspaceをクリア"
            echo "  help      ヘルプを表示"
            echo ""
            echo "グローバルオプション:"
            echo "  -s, --session <id>    セッションIDを指定"
            echo "  -w, --workspace <dir> ワークスペースを指定"
            echo "  -h, --help            ヘルプを表示"
            echo "  -v, --version         バージョンを表示"
            echo ""
            echo "複数プロジェクト並行実行:"
            echo "  # プロジェクトAを起動"
            echo "  ./scripts/ignite start -s proj-a -w /tmp/workspace-a"
            echo ""
            echo "  # プロジェクトBを起動（別セッション）"
            echo "  ./scripts/ignite start -s proj-b -w /tmp/workspace-b"
            echo ""
            echo "  # セッション一覧確認"
            echo "  ./scripts/ignite list"
            echo ""
            echo "例:"
            echo "  ./scripts/ignite start"
            echo "  ./scripts/ignite plan \"READMEを作成する\""
            echo "  ./scripts/ignite status"
            echo "  ./scripts/ignite logs -f"
            echo ""
            echo "詳細なヘルプ:"
            echo "  ./scripts/ignite help <command>"
            ;;
        *)
            print_error "Unknown command: $command"
            cmd_help
            exit 1
            ;;
    esac
}

# =============================================================================
# メイン
# =============================================================================
main() {
    case "${1:-}" in
        start)    shift; cmd_start "$@" ;;
        stop)     shift; cmd_stop "$@" ;;
        list)     cmd_list ;;
        plan)     shift; cmd_plan "$@" ;;
        status)   shift; cmd_status "$@" ;;
        attach)   shift; cmd_attach "$@" ;;
        activate) shift; cmd_activate "$@" ;;
        notify)   shift; cmd_notify "$@" ;;
        logs)     shift; cmd_logs "$@" ;;
        clean)    shift; cmd_clean "$@" ;;
        help)     shift; cmd_help "$@" ;;
        -h|--help) cmd_help ;;
        -v|--version) echo "IGNITE v$VERSION" ;;
        "") cmd_help ;;
        *) print_error "Unknown command: $1"; echo ""; cmd_help; exit 1 ;;
    esac
}

main "$@"
