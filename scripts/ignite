#!/bin/bash
# IGNITE - çµ±åˆã‚³ãƒãƒ³ãƒ‰
# Intelligent Generative Networked Interaction-driven Task Engine

set -e
set -u

VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
SESSION_NAME="ignite-session"

# ã‚«ãƒ©ãƒ¼å®šç¾©
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# å…±é€šé–¢æ•°
print_info() { echo -e "${BLUE}$1${NC}"; }
print_success() { echo -e "${GREEN}âœ“ $1${NC}"; }
print_warning() { echo -e "${YELLOW}âš  $1${NC}"; }
print_error() { echo -e "${RED}âŒ $1${NC}"; }
print_header() { echo -e "${BOLD}${CYAN}=== $1 ===${NC}"; }

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
session_exists() {
    tmux has-session -t "$SESSION_NAME" 2>/dev/null
}

# =============================================================================
# start ã‚³ãƒãƒ³ãƒ‰
# =============================================================================
cmd_start() {
    local no_attach=false
    local force=false

    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -n|--no-attach) no_attach=true; shift ;;
            -f|--force) force=true; shift ;;
            -h|--help) cmd_help start; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help start; exit 1 ;;
        esac
    done

    # ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒãƒ—
    trap 'print_error "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (line $LINENO)"' ERR

    print_header "IGNITE ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•"
    echo ""

    cd "$PROJECT_ROOT"

    # æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
    if session_exists; then
        if [[ "$force" == true ]]; then
            print_warning "æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¼·åˆ¶çµ‚äº†ã—ã¾ã™"
            tmux kill-session -t "$SESSION_NAME"
            print_success "æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã—ãŸ"
        else
            print_warning "æ—¢å­˜ã®ignite-sessionãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            read -p "æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¦å†èµ·å‹•ã—ã¾ã™ã‹? (y/N): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                tmux kill-session -t "$SESSION_NAME"
                print_success "æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã—ãŸ"
            else
                print_info "æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™"
                tmux attach -t "$SESSION_NAME"
                exit 0
            fi
        fi
    fi

    # workspaceã®åˆæœŸåŒ–
    print_info "workspaceã‚’åˆæœŸåŒ–ä¸­..."
    mkdir -p workspace/queue/{leader,strategist,architect,evaluator,coordinator,innovator,ignitians}
    mkdir -p workspace/reports
    mkdir -p workspace/context
    mkdir -p workspace/logs

    # .claude/prompts/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æº–å‚™
    print_info ".claude/prompts/ ã«ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ä¸­..."
    mkdir -p .claude/prompts
    cp instructions/*.md .claude/prompts/

    # åˆæœŸãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ä½œæˆ
    print_info "åˆæœŸãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆä¸­..."
    cat > workspace/dashboard.md <<EOF
# IGNITE Dashboard

æ›´æ–°æ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S')

## ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹
â³ Leader (ä¼Šç¾½ãƒ¦ã‚¤): èµ·å‹•ä¸­...

## ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯
ã‚¿ã‚¹ã‚¯ãªã— - ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­

## æœ€æ–°ãƒ­ã‚°
[$(date '+%H:%M:%S')] ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ã‚’é–‹å§‹ã—ã¾ã—ãŸ
EOF

    print_success "workspaceåˆæœŸåŒ–å®Œäº†"
    echo ""

    # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
    print_info "tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆä¸­..."
    tmux new-session -d -s "$SESSION_NAME" -n ignite -x 200 -y 50

    # Leader ãƒšã‚¤ãƒ³ (pane 0)
    print_info "Leader (ä¼Šç¾½ãƒ¦ã‚¤) ã‚’èµ·å‹•ä¸­..."
    tmux send-keys -t "$SESSION_NAME:0.0" \
        "cd '$PROJECT_ROOT' && claude-code --dangerously-skip-permissions" Enter

    # èµ·å‹•å¾…æ©Ÿ
    print_warning "Leaderã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­... (3ç§’)"
    sleep 3

    # Leaderã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
    print_info "Leaderã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ä¸­..."
    tmux send-keys -t "$SESSION_NAME:0.0" \
        "/prompt leader" Enter

    # ã•ã‚‰ã«å¾…æ©Ÿï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ­ãƒ¼ãƒ‰æ™‚é–“ï¼‰
    sleep 2

    # åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡
    print_info "Leaderã«åˆæœŸåŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ä¸­..."
    cat > workspace/queue/leader/system_init_$(date +%s).yaml <<EOF
type: system_init
from: system
to: leader
timestamp: "$(date -Iseconds)"
priority: high
payload:
  message: "ã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚åˆæœŸåŒ–ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚"
  action: "initialize_dashboard"
status: pending
EOF

    # Leaderã«æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹ã“ã¨ã‚’é€šçŸ¥
    tmux send-keys -t "$SESSION_NAME:0.0" \
        "echo 'ğŸ“¨ æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã™: workspace/queue/leader/'" Enter

    echo ""
    print_success "IGNITE Leader ãŒèµ·å‹•ã—ã¾ã—ãŸ"
    echo ""
    print_header "èµ·å‹•å®Œäº†"
    echo ""
    echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
    echo -e "  1. tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æ¥ç¶š: ${YELLOW}./scripts/ignite attach${NC}"
    echo -e "  2. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç¢ºèª: ${YELLOW}./scripts/ignite status${NC}"
    echo -e "  3. ã‚¿ã‚¹ã‚¯æŠ•å…¥: ${YELLOW}./scripts/ignite plan \"ç›®æ¨™\"${NC}"
    echo ""
    echo "tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³æ“ä½œ:"
    echo -e "  - ãƒ‡ã‚¿ãƒƒãƒ: ${YELLOW}Ctrl+b d${NC}"
    echo -e "  - ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†: ${YELLOW}./scripts/ignite stop${NC}"
    echo ""

    # è‡ªå‹•ã‚¢ã‚¿ãƒƒãƒ
    if [[ "$no_attach" == false ]]; then
        read -p "tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™ã‹? (Y/n): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            tmux attach -t "$SESSION_NAME"
        fi
    fi
}

# =============================================================================
# stop ã‚³ãƒãƒ³ãƒ‰
# =============================================================================
cmd_stop() {
    local skip_confirm=false

    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -y|--yes) skip_confirm=true; shift ;;
            -h|--help) cmd_help stop; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help stop; exit 1 ;;
        esac
    done

    print_header "IGNITE ã‚·ã‚¹ãƒ†ãƒ åœæ­¢"
    echo ""

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å­˜åœ¨ç¢ºèª
    if ! session_exists; then
        print_error "ignite-session ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi

    # ç¢ºèª
    if [[ "$skip_confirm" == false ]]; then
        read -p "IGNITE ã‚·ã‚¹ãƒ†ãƒ ã‚’åœæ­¢ã—ã¾ã™ã‹? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_warning "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"
            exit 0
        fi
    fi

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
    print_warning "tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ä¸­..."
    tmux kill-session -t "$SESSION_NAME"

    print_success "IGNITE ã‚·ã‚¹ãƒ†ãƒ ã‚’åœæ­¢ã—ã¾ã—ãŸ"
}

# =============================================================================
# plan ã‚³ãƒãƒ³ãƒ‰
# =============================================================================
cmd_plan() {
    local goal=""
    local context=""

    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -c|--context) context="$2"; shift 2 ;;
            -h|--help) cmd_help plan; exit 0 ;;
            -*) print_error "Unknown option: $1"; cmd_help plan; exit 1 ;;
            *)
                if [[ -z "$goal" ]]; then
                    goal="$1"
                    shift
                else
                    print_error "å¼•æ•°ãŒå¤šã™ãã¾ã™"
                    cmd_help plan
                    exit 1
                fi
                ;;
        esac
    done

    # å¼•æ•°ãƒã‚§ãƒƒã‚¯
    if [[ -z "$goal" ]]; then
        print_error "ç›®æ¨™ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
        echo ""
        echo "ä½¿ç”¨æ–¹æ³•:"
        echo "  ./scripts/ignite plan \"ç›®æ¨™ã®å†…å®¹\""
        echo "  ./scripts/ignite plan \"ç›®æ¨™\" -c \"ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ\""
        echo ""
        echo "ä¾‹:"
        echo "  ./scripts/ignite plan \"READMEãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹\""
        echo "  ./scripts/ignite plan \"èªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…\" -c \"JWTèªè¨¼ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†\""
        exit 1
    fi

    cd "$PROJECT_ROOT"

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å­˜åœ¨ç¢ºèª
    if ! session_exists; then
        print_error "ignite-session ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        echo -e "${YELLOW}å…ˆã«èµ·å‹•ã—ã¦ãã ã•ã„: ./scripts/ignite start${NC}"
        exit 1
    fi

    print_header "IGNITE ã‚¿ã‚¹ã‚¯æŠ•å…¥"
    echo ""
    echo -e "${BLUE}ç›®æ¨™:${NC} $goal"
    if [[ -n "$context" ]]; then
        echo -e "${BLUE}ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:${NC} $context"
    fi
    echo ""

    # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDç”Ÿæˆ
    local timestamp=$(date -Iseconds)
    local message_id=$(date +%s)

    # Leaderã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    local message_file="workspace/queue/leader/user_goal_${message_id}.yaml"

    if [[ -n "$context" ]]; then
        cat > "$message_file" <<EOF
type: user_goal
from: user
to: leader
timestamp: "${timestamp}"
priority: high
payload:
  goal: "${goal}"
  context: "${context}"
status: pending
EOF
    else
        cat > "$message_file" <<EOF
type: user_goal
from: user
to: leader
timestamp: "${timestamp}"
priority: high
payload:
  goal: "${goal}"
status: pending
EOF
    fi

    print_success "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã—ãŸ: $message_file"

    # Leaderã«é€šçŸ¥ï¼ˆtmux send-keysï¼‰
    tmux send-keys -t "$SESSION_NAME:0.0" "echo ''" Enter
    tmux send-keys -t "$SESSION_NAME:0.0" "echo 'ğŸ“¨ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'" Enter
    tmux send-keys -t "$SESSION_NAME:0.0" "echo 'ğŸ“¨ æ–°ã—ã„ã‚¿ã‚¹ã‚¯ãŒæŠ•å…¥ã•ã‚Œã¾ã—ãŸï¼'" Enter
    tmux send-keys -t "$SESSION_NAME:0.0" "echo 'ğŸ“¨ ç›®æ¨™: ${goal}'" Enter
    tmux send-keys -t "$SESSION_NAME:0.0" "echo 'ğŸ“¨ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«: ${message_file}'" Enter
    tmux send-keys -t "$SESSION_NAME:0.0" "echo 'ğŸ“¨ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'" Enter
    tmux send-keys -t "$SESSION_NAME:0.0" "echo ''" Enter

    echo ""
    print_success "ã‚¿ã‚¹ã‚¯ '${goal}' ã‚’æŠ•å…¥ã—ã¾ã—ãŸ"
    echo ""
    echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
    echo -e "  1. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç¢ºèª: ${YELLOW}./scripts/ignite status${NC}"
    echo -e "  2. ãƒ­ã‚°ç¢ºèª: ${YELLOW}./scripts/ignite logs${NC}"
    echo -e "  3. tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤º: ${YELLOW}./scripts/ignite attach${NC}"
}

# =============================================================================
# status ã‚³ãƒãƒ³ãƒ‰
# =============================================================================
cmd_status() {
    cd "$PROJECT_ROOT"

    print_header "IGNITE ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹"
    echo ""

    # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
    if session_exists; then
        print_success "tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³: å®Ÿè¡Œä¸­"

        # ãƒšã‚¤ãƒ³æ•°ç¢ºèª
        local pane_count=$(tmux list-panes -t "$SESSION_NAME" | wc -l)
        echo -e "${BLUE}  ãƒšã‚¤ãƒ³æ•°: ${pane_count}${NC}"
    else
        print_error "tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³: åœæ­¢"
        exit 1
    fi

    echo ""

    # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
    if [[ -f "workspace/dashboard.md" ]]; then
        print_header "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"
        echo ""
        cat workspace/dashboard.md
        echo ""
    else
        print_warning "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    fi

    # ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹
    print_header "ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹"
    echo ""

    for queue_dir in workspace/queue/*; do
        if [[ -d "$queue_dir" ]]; then
            local queue_name=$(basename "$queue_dir")
            local message_count=$(find "$queue_dir" -name "*.yaml" -type f 2>/dev/null | wc -l)

            if [[ "$message_count" -gt 0 ]]; then
                echo -e "${YELLOW}  $queue_name: $message_count ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸${NC}"
            else
                echo -e "${GREEN}  $queue_name: 0 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸${NC}"
            fi
        fi
    done

    echo ""

    # ãƒ¬ãƒãƒ¼ãƒˆçŠ¶æ…‹
    if [[ -d "workspace/reports" ]]; then
        local report_count=$(find workspace/reports -name "*.yaml" -type f 2>/dev/null | wc -l)
        print_header "ãƒ¬ãƒãƒ¼ãƒˆ"
        echo "  å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ: ${report_count} ä»¶"
        echo ""
    fi

    # æœ€æ–°ãƒ­ã‚°
    print_header "æœ€æ–°ãƒ­ã‚° (ç›´è¿‘5ä»¶)"
    echo ""

    if [[ -d "workspace/logs" ]] && [[ "$(ls -A workspace/logs 2>/dev/null)" ]]; then
        for log_file in workspace/logs/*.log; do
            if [[ -f "$log_file" ]]; then
                echo -e "${BLUE}$(basename "$log_file"):${NC}"
                tail -n 5 "$log_file" 2>/dev/null | sed 's/^/  /'
                echo ""
            fi
        done
    else
        print_warning "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
        echo ""
    fi

    print_header "ã‚³ãƒãƒ³ãƒ‰"
    echo -e "  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç›£è¦–: ${YELLOW}watch -n 5 cat workspace/dashboard.md${NC}"
    echo -e "  tmuxã‚¢ã‚¿ãƒƒãƒ: ${YELLOW}./scripts/ignite attach${NC}"
    echo -e "  ã‚·ã‚¹ãƒ†ãƒ åœæ­¢: ${YELLOW}./scripts/ignite stop${NC}"
}

# =============================================================================
# attach ã‚³ãƒãƒ³ãƒ‰
# =============================================================================
cmd_attach() {
    if ! session_exists; then
        print_error "ignite-session ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        echo -e "${YELLOW}å…ˆã«èµ·å‹•ã—ã¦ãã ã•ã„: ./scripts/ignite start${NC}"
        exit 1
    fi

    tmux attach -t "$SESSION_NAME"
}

# =============================================================================
# logs ã‚³ãƒãƒ³ãƒ‰
# =============================================================================
cmd_logs() {
    local follow=false
    local lines=20

    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--follow) follow=true; shift ;;
            -n|--lines) lines="$2"; shift 2 ;;
            -h|--help) cmd_help logs; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help logs; exit 1 ;;
        esac
    done

    cd "$PROJECT_ROOT"

    if [[ ! -d "workspace/logs" ]] || [[ -z "$(ls -A workspace/logs 2>/dev/null)" ]]; then
        print_warning "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 0
    fi

    if [[ "$follow" == true ]]; then
        print_info "ãƒ­ã‚°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ä¸­... (Ctrl+C ã§çµ‚äº†)"
        tail -f workspace/logs/*.log 2>/dev/null
    else
        print_header "ãƒ­ã‚° (ç›´è¿‘${lines}è¡Œ)"
        echo ""
        for log_file in workspace/logs/*.log; do
            if [[ -f "$log_file" ]]; then
                echo -e "${BLUE}=== $(basename "$log_file") ===${NC}"
                tail -n "$lines" "$log_file" 2>/dev/null
                echo ""
            fi
        done
    fi
}

# =============================================================================
# clean ã‚³ãƒãƒ³ãƒ‰
# =============================================================================
cmd_clean() {
    local skip_confirm=false

    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -y|--yes) skip_confirm=true; shift ;;
            -h|--help) cmd_help clean; exit 0 ;;
            *) print_error "Unknown option: $1"; cmd_help clean; exit 1 ;;
        esac
    done

    cd "$PROJECT_ROOT"

    print_header "IGNITE workspaceã‚¯ãƒªã‚¢"
    echo ""

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œä¸­ã®å ´åˆã¯è­¦å‘Š
    if session_exists; then
        print_warning "ignite-session ãŒå®Ÿè¡Œä¸­ã§ã™"
        echo "å…ˆã«ã‚·ã‚¹ãƒ†ãƒ ã‚’åœæ­¢ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™: ./scripts/ignite stop"
        echo ""
    fi

    # ç¢ºèª
    if [[ "$skip_confirm" == false ]]; then
        echo "ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™:"
        echo "  - workspace/queue/*"
        echo "  - workspace/reports/*"
        echo "  - workspace/logs/*"
        echo "  - workspace/context/*"
        echo "  - workspace/dashboard.md"
        echo ""
        read -p "ç¶šè¡Œã—ã¾ã™ã‹? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_warning "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"
            exit 0
        fi
    fi

    # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ
    print_info "workspaceã‚’ã‚¯ãƒªã‚¢ä¸­..."

    rm -rf workspace/queue/*/
    mkdir -p workspace/queue/{leader,strategist,architect,evaluator,coordinator,innovator,ignitians}

    rm -rf workspace/reports/*
    rm -rf workspace/logs/*
    rm -rf workspace/context/*
    rm -f workspace/dashboard.md

    print_success "workspaceã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ"
}

# =============================================================================
# help ã‚³ãƒãƒ³ãƒ‰
# =============================================================================
cmd_help() {
    local command="${1:-}"

    case "$command" in
        start)
            echo "ä½¿ç”¨æ–¹æ³•: ./scripts/ignite start [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]"
            echo ""
            echo "IGNITE ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ã—ã¾ã™"
            echo ""
            echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
            echo "  -n, --no-attach    èµ·å‹•å¾Œã«è‡ªå‹•ã‚¢ã‚¿ãƒƒãƒã—ãªã„"
            echo "  -f, --force        æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¼·åˆ¶çµ‚äº†ã—ã¦å†èµ·å‹•"
            echo "  -h, --help         ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
            echo ""
            echo "ä¾‹:"
            echo "  ./scripts/ignite start"
            echo "  ./scripts/ignite start --no-attach"
            echo "  ./scripts/ignite start -f"
            ;;
        stop)
            echo "ä½¿ç”¨æ–¹æ³•: ./scripts/ignite stop [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]"
            echo ""
            echo "IGNITE ã‚·ã‚¹ãƒ†ãƒ ã‚’åœæ­¢ã—ã¾ã™"
            echo ""
            echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
            echo "  -y, --yes    ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—"
            echo "  -h, --help   ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
            echo ""
            echo "ä¾‹:"
            echo "  ./scripts/ignite stop"
            echo "  ./scripts/ignite stop -y"
            ;;
        plan)
            echo "ä½¿ç”¨æ–¹æ³•: ./scripts/ignite plan <ç›®æ¨™> [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]"
            echo ""
            echo "ã‚¿ã‚¹ã‚¯ã‚’æŠ•å…¥ã—ã¾ã™"
            echo ""
            echo "å¼•æ•°:"
            echo "  <ç›®æ¨™>    å®Ÿè¡Œã—ãŸã„ã‚¿ã‚¹ã‚¯ã®ç›®æ¨™"
            echo ""
            echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
            echo "  -c, --context <text>    ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ "
            echo "  -h, --help              ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
            echo ""
            echo "ä¾‹:"
            echo "  ./scripts/ignite plan \"READMEã‚’ä½œæˆã™ã‚‹\""
            echo "  ./scripts/ignite plan \"èªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…\" -c \"JWTèªè¨¼ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†\""
            ;;
        status)
            echo "ä½¿ç”¨æ–¹æ³•: ./scripts/ignite status"
            echo ""
            echo "ã‚·ã‚¹ãƒ†ãƒ ã®çŠ¶æ…‹ã‚’è¡¨ç¤ºã—ã¾ã™"
            echo ""
            echo "è¡¨ç¤ºå†…å®¹:"
            echo "  - tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹"
            echo "  - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"
            echo "  - ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹"
            echo "  - ãƒ¬ãƒãƒ¼ãƒˆæ•°"
            echo "  - æœ€æ–°ãƒ­ã‚°"
            ;;
        attach)
            echo "ä½¿ç”¨æ–¹æ³•: ./scripts/ignite attach"
            echo ""
            echo "tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æ¥ç¶šã—ã¾ã™"
            echo ""
            echo "tmuxæ“ä½œ:"
            echo "  Ctrl+b d    ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒ‡ã‚¿ãƒƒãƒ"
            echo "  Ctrl+b o    æ¬¡ã®ãƒšã‚¤ãƒ³ã«ç§»å‹•"
            echo "  Ctrl+b [    ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ‰"
            ;;
        logs)
            echo "ä½¿ç”¨æ–¹æ³•: ./scripts/ignite logs [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]"
            echo ""
            echo "ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™"
            echo ""
            echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
            echo "  -f, --follow        ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦– (tail -f)"
            echo "  -n, --lines <N>     è¡¨ç¤ºè¡Œæ•° (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 20)"
            echo "  -h, --help          ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
            echo ""
            echo "ä¾‹:"
            echo "  ./scripts/ignite logs"
            echo "  ./scripts/ignite logs -f"
            echo "  ./scripts/ignite logs -n 50"
            ;;
        clean)
            echo "ä½¿ç”¨æ–¹æ³•: ./scripts/ignite clean [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]"
            echo ""
            echo "workspaceã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™"
            echo ""
            echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
            echo "  -y, --yes    ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—"
            echo "  -h, --help   ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
            echo ""
            echo "ä¾‹:"
            echo "  ./scripts/ignite clean"
            echo "  ./scripts/ignite clean -y"
            ;;
        "")
            echo -e "${BOLD}IGNITE${NC} - Intelligent Generative Networked Interaction-driven Task Engine"
            echo ""
            echo "ä½¿ç”¨æ–¹æ³•: ./scripts/ignite <command> [options] [arguments]"
            echo ""
            echo "ã‚³ãƒãƒ³ãƒ‰:"
            echo "  start     ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•"
            echo "  stop      ã‚·ã‚¹ãƒ†ãƒ ã‚’åœæ­¢"
            echo "  plan      ã‚¿ã‚¹ã‚¯ã‚’æŠ•å…¥"
            echo "  status    çŠ¶æ…‹ã‚’ç¢ºèª"
            echo "  attach    tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æ¥ç¶š"
            echo "  logs      ãƒ­ã‚°ã‚’è¡¨ç¤º"
            echo "  clean     workspaceã‚’ã‚¯ãƒªã‚¢"
            echo "  help      ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
            echo ""
            echo "ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
            echo "  -h, --help       ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
            echo "  -v, --version    ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¡¨ç¤º"
            echo ""
            echo "ä¾‹:"
            echo "  ./scripts/ignite start"
            echo "  ./scripts/ignite plan \"READMEã‚’ä½œæˆã™ã‚‹\""
            echo "  ./scripts/ignite status"
            echo "  ./scripts/ignite logs -f"
            echo ""
            echo "è©³ç´°ãªãƒ˜ãƒ«ãƒ—:"
            echo "  ./scripts/ignite help <command>"
            ;;
        *)
            print_error "Unknown command: $command"
            cmd_help
            exit 1
            ;;
    esac
}

# =============================================================================
# ãƒ¡ã‚¤ãƒ³
# =============================================================================
main() {
    case "${1:-}" in
        start)  shift; cmd_start "$@" ;;
        stop)   shift; cmd_stop "$@" ;;
        plan)   shift; cmd_plan "$@" ;;
        status) cmd_status ;;
        attach) cmd_attach ;;
        logs)   shift; cmd_logs "$@" ;;
        clean)  shift; cmd_clean "$@" ;;
        help)   shift; cmd_help "$@" ;;
        -h|--help) cmd_help ;;
        -v|--version) echo "IGNITE v$VERSION" ;;
        "") cmd_help ;;
        *) print_error "Unknown command: $1"; echo ""; cmd_help; exit 1 ;;
    esac
}

main "$@"
