#!/bin/bash
# IGNITE - 統合コマンド
# Intelligent Generative Networked Interaction-driven Task Engine

set -euo pipefail

LIB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/lib" && pwd)"

# Layer 0: 定数・ユーティリティ
source "${LIB_DIR}/core.sh"
source "${LIB_DIR}/yaml_utils.sh"

# Layer 1: 基盤サービス
source "${LIB_DIR}/session.sh"
source "${LIB_DIR}/agent.sh"
source "${LIB_DIR}/cost_utils.sh"

# Layer 2: ヘルプ（他コマンドに依存しない）
source "${LIB_DIR}/cmd_help.sh"

# Layer 3: コマンド群（Layer 0-2に依存）
source "${LIB_DIR}/cmd_start.sh"
source "${LIB_DIR}/cmd_stop.sh"
source "${LIB_DIR}/cmd_status.sh"
source "${LIB_DIR}/cmd_plan.sh"
source "${LIB_DIR}/cmd_cost.sh"
source "${LIB_DIR}/cmd_work_on.sh"
source "${LIB_DIR}/config_validator.sh"
source "${LIB_DIR}/commands.sh"

main() {
    case "${1:-}" in
        start)    shift; cmd_start "$@" ;;
        stop)     shift; cmd_stop "$@" ;;
        list)     cmd_list ;;
        plan)     shift; cmd_plan "$@" ;;
        status)   shift; cmd_status "$@" ;;
        cost)     shift; cmd_cost "$@" ;;
        attach)   shift; cmd_attach "$@" ;;
        activate) shift; cmd_activate "$@" ;;
        notify)   shift; cmd_notify "$@" ;;
        logs)     shift; cmd_logs "$@" ;;
        clean)    shift; cmd_clean "$@" ;;
        work-on)  shift; cmd_work_on "$@" ;;
        watcher)  shift; cmd_watcher "$@" ;;
        validate) shift; cmd_validate "$@" ;;
        help)     shift; cmd_help "$@" ;;
        -h|--help) cmd_help ;;
        -v|--version) echo "IGNITE v$VERSION" ;;
        "") cmd_help ;;
        *) print_error "Unknown command: $1"; echo ""; cmd_help; exit 1 ;;
    esac
}

main "$@"
