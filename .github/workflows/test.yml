name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  bats-test:
    name: Bats Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bats
        uses: bats-core/bats-action@2.0.0
        with:
          detik-install: false

      - name: Verify sqlite3 availability
        run: sqlite3 --version

      - name: Setup systemd user environment
        run: |
          # XDG_RUNTIME_DIR が設定されていることを確認
          echo "XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-/run/user/$(id -u)}" >> "$GITHUB_ENV"
          # loginctl enable-linger（enable テストの linger チェック対応）
          loginctl enable-linger "$(whoami)" || true

      - name: Run Bats tests
        run: bats tests/

  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
          format: tty

  pytest:
    name: Pytest
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install pytest
        run: pip install pytest

      - name: Run pytest
        run: python -m pytest tests/ -v

  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify sqlite3 availability
        run: sqlite3 --version

      - name: Install opencode
        run: curl -fsSL https://raw.githubusercontent.com/opencode-ai/opencode/refs/heads/main/install | bash

      - name: Setup systemd user environment
        run: |
          echo "XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-/run/user/$(id -u)}" >> "$GITHUB_ENV"
          loginctl enable-linger "$(whoami)" || true

      - name: Run smoke tests
        run: ./scripts/smoke_test.sh --ci

  test:
    name: test
    runs-on: ubuntu-latest
    needs: [bats-test, shellcheck, pytest, smoke-test]
    if: always()
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.bats-test.result }}" != "success" || "${{ needs.shellcheck.result }}" != "success" || "${{ needs.pytest.result }}" != "success" || "${{ needs.smoke-test.result }}" != "success" ]]; then
            echo "One or more checks failed"
            exit 1
          fi
