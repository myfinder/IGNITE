# GitHub App（ignite-gh-app）導入ガイド

IGNITEのGitHub連携機能を使用するための **ignite-gh-app** の導入手順を説明します。

> **開発者向けドキュメント**: GitHub Appを自分で作成する場合は [github-app-setup.md](./github-app-setup.md) を参照してください。
> このガイドは、公開済みの **ignite-gh-app** をインストールして使い始める方を対象としています。

## 1. 前提条件

以下のツールがインストールされている必要があります:

- **IGNITE** がインストール済みであること（[README](../README.md) 参照）
- **GitHub CLI (gh)** がインストール済みであること

```bash
# IGNITE の確認
ignite --version

# GitHub CLI の確認
gh --version

# gh-token 拡張のインストール（未インストールの場合）
gh extension install Link-/gh-token
```

## 2. ignite-gh-app の概要

### GitHub App とは

GitHub App は、GitHub 上で Bot 的な動作を実現するための仕組みです。ignite-gh-app を使うと、以下のことが可能になります:

- **Issue の自動処理**: Issue に `@ignite-gh-app` とメンションすると、IGNITE が自動で対応を開始
- **PR の自動作成**: Issue の内容を分析して、修正 PR を自動作成
- **Bot 名義での応答**: IGNITE からのコメントが `ignite-gh-app[bot]` として表示され、人間の操作と明確に区別
- **ラベルベースの自動トリガー**: `ignite-auto` 等のラベルが付いた Issue を自動処理

### できること

| 機能 | 説明 |
|------|------|
| Issue 監視 | 新規 Issue やコメントを自動検知 |
| PR 監視 | 新規 PR やレビューコメントを自動検知 |
| メンション応答 | `@ignite-gh-app 実装して` で実装タスクを開始 |
| 自動 PR 作成 | Issue に対する修正 PR を Bot 名義で作成 |
| 進捗報告 | 処理状況を Issue にコメントとして投稿 |

### 必要な権限

ignite-gh-app は以下の権限を要求します:

| 権限 | レベル | 用途 |
|------|--------|------|
| **Contents** | Read and write | ファイルの読み書き、コミット作成 |
| **Issues** | Read and write | Issue の閲覧・コメント・作成 |
| **Pull requests** | Read and write | PR の閲覧・コメント・作成 |
| **Metadata** | Read-only | リポジトリのメタデータ取得 |

## 3. インストール手順

### Step 1: App ページにアクセス

以下の URL にアクセスして ignite-gh-app のインストールページを開きます:

**https://github.com/apps/ignite-gh-app**

「Install」ボタンをクリックします。

### Step 2: インストール先を選択

インストール先のアカウントまたは Organization を選択します。

- **All repositories**: 全リポジトリに対して有効化
- **Only select repositories**: 特定のリポジトリのみ有効化（推奨）

> **推奨**: 最初は特定のリポジトリのみを選択し、動作確認後に必要に応じて追加してください。

### Step 3: 権限を確認

表示される権限一覧を確認します（前述の権限表を参照）。問題がなければ「Install」をクリックします。

### Step 4: IGNITE の設定

#### 4-1. GitHub App 設定ファイルを作成

```bash
# テンプレートをコピー
cp config/github-app.yaml.example config/github-app.yaml
```

設定ファイルを編集して、App ID と Private Key のパスを入力します:

```yaml
# config/github-app.yaml
github_app:
  app_id: "YOUR_APP_ID"
  private_key_path: "~/.config/ignite/github-app-private-key.pem"
  app_name: "ignite-gh-app"
```

> **Note**: App ID は GitHub App の設定ページで確認できます。Private Key の生成方法は [github-app-setup.md](./github-app-setup.md) を参照してください。

#### 4-2. GitHub Watcher の設定

監視対象のリポジトリを設定します:

```bash
# テンプレートをコピー（初回のみ）
cp config/github-watcher.yaml.example config/github-watcher.yaml
```

`config/github-watcher.yaml` に監視対象リポジトリを追加:

```yaml
watcher:
  repositories:
    - repo: your-org/your-repo
    # 複数リポジトリを監視する場合:
    # - repo: your-org/another-repo
    #   base_branch: develop

  # ポーリング間隔（秒）。推奨: 60秒以上
  interval: 60
```

## 4. 動作確認

### 起動

GitHub Watcher を有効にして IGNITE を起動します:

```bash
ignite start --with-watcher
```

> **Note**: `config/github-watcher.yaml` で `auto_start.enabled: true` に設定すると、`--with-watcher` オプションなしでも自動起動します。

### メンションテスト

対象リポジトリで任意の Issue を開き、以下のコメントを投稿します:

```
@ignite-gh-app 説明して
```

正常に動作していれば、しばらく後に `ignite-gh-app[bot]` から応答コメントが投稿されます。

### 自動トリガーテスト

`ignite-auto` ラベルを付けた Issue を作成すると、自動的に IGNITE が処理を開始します。

```
タイトル: テスト Issue
本文: この Issue はテストです
ラベル: ignite-auto
```

## 5. カスタマイズ

`config/github-watcher.yaml` で以下の設定をカスタマイズできます。

### トリガーキーワード

```yaml
triggers:
  mention_pattern: "@ignite-gh-app"
  keywords:
    implement:
      - "実装して"
      - "implement"
      - "fix this"
      - "PRを作成"
    review:
      - "レビューして"
      - "review"
    explain:
      - "説明して"
      - "explain"
    insights:
      - "インサイト"
      - "insights"
```

### 応答テンプレート

```yaml
responses:
  # タスク受付時の自動コメント
  acknowledge: true
  acknowledge_template: |
    このIssueを確認しました。処理を開始します。
    ---
    *Generated by IGNITE AI Team*

  # 成功時の自動コメント
  report_success: true
  success_template: |
    ✅ 処理が完了しました！
    {details}
    ---
    *Generated by IGNITE AI Team*
```

### 監視間隔

```yaml
watcher:
  # ポーリング間隔（秒）
  # GitHub API レート制限: 認証済み 5000 requests/hour
  # 推奨: 60秒以上
  interval: 60
```

### アクセス制御

```yaml
access_control:
  # true: ホワイトリストのユーザーのみ許可
  enabled: true
  allowed_users:
    - "admin-user"
    - "trusted-developer"
```

## 6. トラブルシューティング

### IGNITE が Issue に反応しない

**確認事項**:

1. **Watcher が起動しているか確認**:
   ```bash
   ignite status
   ```
   GitHub Watcher が `running` と表示されていることを確認してください。

2. **監視対象リポジトリの設定を確認**:
   ```bash
   cat config/github-watcher.yaml
   ```
   `watcher.repositories` に対象リポジトリが含まれているか確認してください。

3. **GitHub App がリポジトリにインストール済みか確認**:
   GitHub の対象リポジトリの Settings > Integrations > GitHub Apps で `ignite-gh-app` が表示されているか確認してください。

4. **ログを確認**:
   ```bash
   cat workspace/logs/github_watcher.log
   ```

### 権限エラー（`Resource not accessible by integration`）

**原因**: GitHub App に必要な権限が付与されていません。

**対処**:
1. https://github.com/settings/installations にアクセス
2. `ignite-gh-app` の「Configure」をクリック
3. 「Repository permissions」で必要な権限（Contents, Issues, Pull requests）が付与されているか確認
4. 権限変更後、リポジトリへの再インストールが必要な場合があります

### 無限ループ（Bot が自分のコメントに反応し続ける）

**通常は自動防止されます**: GitHub Watcher は `ignore_bot: true` がデフォルトで設定されており、Bot の投稿には反応しません。

もし発生した場合:
1. `config/github-watcher.yaml` の `ignore_bot` 設定を確認:
   ```yaml
   watcher:
     ignore_bot: true
   ```
2. IGNITE を一度停止して再起動:
   ```bash
   ignite stop
   ignite start --with-watcher
   ```

## 7. アンインストール方法

### GitHub 側の削除

1. https://github.com/settings/installations にアクセス
2. `ignite-gh-app` の「Configure」をクリック
3. ページ下部の「Uninstall」をクリック

### IGNITE 側の設定削除

```bash
# GitHub App 設定ファイルを削除
rm config/github-app.yaml

# GitHub Watcher 設定ファイルを削除（GitHub Watcher自体を使用しない場合）
rm config/github-watcher.yaml

# Private Key を削除
rm ~/.config/ignite/github-app-private-key.pem
```

> **Note**: GitHub Watcher を引き続き使用する場合は、`config/github-watcher.yaml` は削除しないでください。

## 8. セキュリティ注意事項

1. **Private Key の保護**: `~/.config/ignite/github-app-private-key.pem` は `chmod 600` で権限を制限し、決してリポジトリにコミットしないでください
2. **最小権限の原則**: インストール時は「Only select repositories」を選択し、必要なリポジトリのみにインストールしてください
3. **トークンの扱い**: GitHub App Token は短期間で自動失効しますが、ログファイル等に出力しないよう注意してください
4. **設定ファイルの管理**: `config/github-app.yaml` は `.gitignore` に追加されており、リポジトリにコミットされません
5. **アクセス制御**: `config/github-watcher.yaml` の `access_control` でメンショントリガーを許可するユーザーを制限してください

## 関連ドキュメント

- [GitHub App 設定ガイド（開発者向け）](./github-app-setup.md) — GitHub App を自分で作成する手順
- [GitHub Watcher 使用ガイド](./github-watcher.md) — イベント監視システムの詳細設定
- [アーキテクチャ](./architecture.md) — システム構造の詳細
- [プロトコル仕様](./protocol.md) — メッセージフォーマット
